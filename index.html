<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Премиальный интерактивный трекер обучения фронтенд разработке: революционный подход к изучению веб-технологий за 8 месяцев.">
  <meta property="og:title" content="Премиальный трекер обучения фронтенду">
  <meta property="og:description" content="Элитный план обучения веб-разработке на 196 дней с премиальным UX и продвинутой аналитикой.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ru_RU">
  <title>Premium Learning Tracker - Frontend Mastery</title>

  <!-- Premium Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      /* === ПРЕМИУМ ПАЛИТРА: СОВРЕМЕННЫЕ ГРАДИЕНТЫ === */
      --bg-primary: #0a0a0f;
      --bg-secondary: #111118;
      --bg-tertiary: #1a1a24;
      --bg-card: #232330;
      --bg-elevated: #2a2a3a;
      --text-primary: #ffffff;
      --text-secondary: #b4b4c8;
      --text-muted: #8e8ea0;
      --border-color: rgba(255, 255, 255, 0.08);
      --border-accent: rgba(99, 102, 241, 0.3);

      /* === SIGNATURE BRAND COLORS === */
      --accent-primary: #6366f1; /* Indigo */
      --accent-secondary: #8b5cf6; /* Violet */
      --accent-tertiary: #06b6d4; /* Cyan */
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;

      /* === PREMIUM GRADIENTS === */
      --gradient-hero: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);

      /* === LUXE SHADOWS & GLOWS === */
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.12);
      --shadow-md: 0 8px 32px rgba(0,0,0,0.24);
      --shadow-lg: 0 16px 64px rgba(0,0,0,0.32);
      --shadow-xl: 0 32px 128px rgba(0,0,0,0.48);
      --glow-primary: 0 0 64px rgba(99, 102, 241, 0.4);
      --glow-accent: 0 0 32px rgba(139, 92, 246, 0.3);

      /* === FLUID TYPOGRAPHY SCALE === */
      --text-xs: clamp(10px, 0.8vw, 12px);
      --text-sm: clamp(12px, 1vw, 14px);
      --text-base: clamp(14px, 1.2vw, 16px);
      --text-lg: clamp(16px, 1.4vw, 20px);
      --text-xl: clamp(20px, 1.8vw, 24px);
      --text-2xl: clamp(24px, 2.4vw, 32px);
      --text-3xl: clamp(32px, 3.2vw, 48px);
      --text-hero: clamp(48px, 5vw, 72px);

      /* === MICRO-INTERACTION TIMING === */
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-bounce: 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);

      /* === PREMIUM SPACING (GOLDEN RATIO) === */
      --space-xs: 0.25rem;
      --space-sm: 0.5rem;
      --space-md: 0.75rem;
      --space-lg: 1rem;
      --space-xl: 1.618rem;
      --space-2xl: 2.618rem;
      --space-3xl: 4.236rem;
      --space-4xl: 6.854rem;

      /* === LUXE BORDERS & RADIUS === */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-2xl: 32px;
      --radius-full: 9999px;

      /* === FOCUS STATES === */
      --focus-ring: 0 0 0 3px rgba(99, 102, 241, 0.3);

      /* === GLASS MORPHISM === */
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-blur: blur(20px);
    }

    /* === ПРЕМИУМ LIGHT THEME === */
    @media (prefers-color-scheme: light) {
      :root {
        --bg-primary: #fafbff;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f8fafc;
        --bg-card: #f1f5f9;
        --bg-elevated: #e2e8f0;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --border-color: rgba(15, 23, 42, 0.08);
        --glass-bg: rgba(255, 255, 255, 0.8);
        --glass-border: rgba(15, 23, 42, 0.1);
      }
    }

    /* === CORE STYLES === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
      scroll-padding-top: var(--space-4xl);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      overflow-x: hidden;
      transition: all var(--transition-slow);
    }

    /* Theme + component smooth transitions */
    body, .container, .month, .day, .week, .cat-card, .cloud-indicator, .cloud-g-btn, .cloud-btn, .cloud-mini-btn {
      transition: background .55s ease, color .45s ease, border-color .5s ease, box-shadow .6s ease, transform .45s cubic-bezier(.4,0,.2,1);
    }
    body.theme-switching::after { content:""; position:fixed; inset:0; pointer-events:none; background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.15), rgba(0,0,0,.4)); animation: themeFade 0.6s ease; mix-blend-mode:overlay; }
    @keyframes themeFade { from { opacity:0 } to { opacity:1 } }
    @keyframes scaleInSoft { 0%{ transform:scale(.96) translateY(6px); opacity:0 } 100%{ transform:scale(1) translateY(0); opacity:1 } }
    @keyframes slideDown { 0%{ max-height:0; opacity:0 } 100%{ max-height:1200px; opacity:1 } }
    @keyframes pulseGlow { 0%,100%{ box-shadow:0 0 0 0 rgba(123,91,255,0.0) } 50%{ box-shadow:0 0 0 8px rgba(123,91,255,0.15) } }
    .anim-scale-in { animation: scaleInSoft .5s cubic-bezier(.4,0,.2,1); }
    .anim-slide-down { animation: slideDown .6s cubic-bezier(.4,0,.2,1); overflow:hidden; }
    .anim-pulse-glow { animation: pulseGlow 2.4s ease-in-out infinite; }

    /* === PREMIUM SCROLLBAR === */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gradient-primary);
      border-radius: var(--radius-full);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-primary);
    }

    /* === GLASS MORPHISM CONTAINER === */
    .container {
      max-width: 1600px;
      margin: var(--space-lg) auto;
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-2xl);
      overflow: hidden;
      box-shadow: var(--shadow-xl);
      position: relative;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gradient-primary);
      z-index: 1;
    }

    .container::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background:
        radial-gradient(circle at 25% 25%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
      animation: rotate 20s linear infinite;
      z-index: -1;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* === REVOLUTIONARY HERO HEADER === */
    .header {
      background: var(--gradient-hero);
      color: white;
      padding: var(--space-4xl) var(--space-2xl);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    /* Animated Background Particles */
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(6, 182, 212, 0.2) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      z-index: 0;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-20px) rotate(1deg); }
      66% { transform: translateY(10px) rotate(-1deg); }
    }

    .header > * {
      position: relative;
      z-index: 2;
    }

    .header h1 {
      font-size: var(--text-hero);
      font-weight: 800;
      letter-spacing: -0.025em;
      margin-bottom: var(--space-xl);
      background: linear-gradient(135deg, #ffffff, #e2e8f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.1;
    }

    .header p {
      font-size: var(--text-xl);
      font-weight: 500;
      opacity: 0.9;
      margin-bottom: var(--space-2xl);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    /* === FLOATING ACTION BUTTON === */
    .theme-toggle {
      position: absolute;
      top: var(--space-xl);
      right: var(--space-xl);
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      color: white;
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius-full);
      cursor: pointer;
      font-size: var(--text-lg);
      z-index: 10;
      transition: all var(--transition-base);
      box-shadow: var(--shadow-md);
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
      box-shadow: var(--glow-accent);
    }

    /* === PREMIUM STATS GRID === */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-xl);
      padding: var(--space-3xl) var(--space-xl);
      background: var(--bg-secondary);
      position: relative;
    }

    .stats::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: var(--gradient-primary);
      border-radius: var(--radius-full);
    }

    .stat {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--space-2xl);
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all var(--transition-base);
      cursor: pointer;
    }

    /* === REVOLUTIONARY PROGRESS BAR === */
    .progress-bar {
      height: 20px;
      background: var(--bg-tertiary);
      margin: 0 var(--space-2xl) var(--space-3xl);
      border-radius: var(--radius-full);
      overflow: hidden;
      border: 2px solid var(--border-color);
      position: relative;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient-primary);
      transition: width .45s cubic-bezier(.4,0,.2,1), filter .6s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      color: white;
      font-weight: 700;
      font-size: var(--text-sm);
      padding-right: var(--space-lg);
      position: relative;
      overflow: hidden;
    }

    .progress-fill.pulse-boost { filter: brightness(1.15) saturate(1.15); }
    .progress-fill.pulse-boost::after { content:""; position:absolute; inset:0; background:radial-gradient(circle at 60% 50%, rgba(255,255,255,.35), transparent 70%); opacity:.0; animation: pfPulse .9s ease forwards; pointer-events:none; }
    @keyframes pfPulse { 0%{ opacity:.8; transform:scale(.9);} 60%{opacity:.15; transform:scale(1.15);} 100%{opacity:0; transform:scale(1.25);} }

    .progress-fill::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,0.3) 50%,
        transparent 100%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .stat::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity var(--transition-base);
    }

    .stat:hover {
      transform: translateY(-8px);
      box-shadow: var(--glow-primary);
      border-color: var(--accent-primary);
    }

    .stat:hover::before {
      opacity: 1;
    }

    .stat h3 {
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin-bottom: var(--space-lg);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
    }

    .stat .num {
      font-size: var(--text-3xl);
      font-weight: 900;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
      margin-bottom: var(--space-md);
      transition: all var(--transition-base);
    }

    .stat:hover .num {
      transform: scale(1.1);
    }

    /* === PREMIUM CATEGORIES GRID === */
    .categories-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-lg);
      padding: 0 var(--space-xl) var(--space-3xl);
      margin: 0 auto;
      max-width: 1400px;
    }

    @media (min-width: 768px) {
      .categories-summary {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-xl);
      }
    }

    @media (min-width: 1200px) {
      .categories-summary {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }

    .cat-card {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--space-lg);
      position: relative;
      overflow: hidden;
      transition: all var(--transition-base);
      cursor: pointer;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .cat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity var(--transition-base);
    }

    .cat-card:hover {
      transform: translateY(-12px);
      box-shadow: var(--glow-primary);
      border-color: var(--accent-primary);
    }

    .cat-card:hover::before {
      opacity: 1;
    }

    .cat-card h4 {
      margin: 0 0 var(--space-md);
      font-size: var(--text-sm);
      font-weight: 700;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .cat-metric {
      font-size: var(--text-xl);
      font-weight: 900;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: var(--space-sm) 0;
      line-height: 1;
    }

    .cat-bar {
      height: 6px;
      background: var(--bg-card);
      border-radius: var(--radius-full);
      overflow: hidden;
      position: relative;
      margin: var(--space-md) 0;
    }

    .cat-bar span {
      display: block;
      height: 100%;
      width: 0;
      background: var(--gradient-primary);
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border-radius: var(--radius-full);
    }

    .cat-pct {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-secondary);
      margin-top: auto;
    }

    /* === PREMIUM RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
      .container {
        margin: var(--space-md);
        border-radius: var(--radius-xl);
      }

      .header {
        padding: var(--space-3xl) var(--space-xl);
      }

      .header h1 {
        font-size: var(--text-2xl);
      }

      .stats {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: var(--space-lg);
        padding: var(--space-2xl) var(--space-lg);
      }

      .categories-summary {
        grid-template-columns: 1fr;
        gap: var(--space-lg);
        padding: 0 var(--space-lg) var(--space-2xl);
      }

      .progress-bar {
        margin: 0 var(--space-lg) var(--space-2xl);
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: var(--space-2xl) var(--space-lg);
      }

      .header h1 {
        font-size: var(--text-xl);
      }

      .stats {
        grid-template-columns: 1fr;
        gap: var(--space-md);
        padding: var(--space-xl) var(--space-md);
      }

      .theme-toggle {
        top: var(--space-lg);
        right: var(--space-lg);
        padding: var(--space-sm) var(--space-md);
      }
    }

    .cat-card.highlight {
      box-shadow: 0 0 0 2px var(--accent-color), var(--shadow-lg);
      transform: translateY(-3px);
      background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-card));
    }

    /* Декоративный элемент для карточек */
    .cat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
      opacity: 0.7;
    }

    /* === PREMIUM CATEGORIES GRID === */

    .controls {
      padding: var(--space-6) var(--space-6);
      display: flex;
      gap: var(--space-4);
      flex-wrap: wrap;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
    }

    input {
      flex: 1;
      min-width: 240px;
      padding: var(--space-4) var(--space-5);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-m);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: var(--text-base);
      transition: var(--transition);
      font-weight: 500;
      line-height: 1.5;
    }

    input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: var(--focus-ring);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    button {
      padding: var(--space-4) var(--space-6);
      border: none;
      border-radius: var(--radius-m);
      cursor: pointer;
      font-weight: 600;
      font-size: var(--text-sm);
      transition: var(--transition);
      letter-spacing: 0.3px;
      line-height: 1.4;
    }
    button:focus-visible, input:focus-visible, textarea:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    /* === ИСПРАВЛЕННАЯ СИСТЕМА КНОПОК === */
    .btn, .btn-filter, .qp-btn, .cloud-btn {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-l);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.3px;
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      transition: var(--transition);
      position: relative;
      line-height: 1.4;
    }
    .btn:hover, .btn:focus-visible,
    .btn-filter:hover, .btn-filter:focus-visible,
    .qp-btn:hover, .qp-btn:focus-visible {
      background: var(--gradient-primary);
      color: #fff;
      box-shadow: var(--shadow-sm);
      outline: none;
      transform: translateY(-1px);
    }
    .btn.active, .btn-filter.active {
      background: var(--gradient-primary);
      color: #fff;
      box-shadow: var(--shadow-sm);
    }
    .btn.sm {
      padding: var(--space-1) var(--space-3);
      font-size: var(--text-xs);
    }
    .btn.lg {
      padding: var(--space-3) var(--space-5);
      font-size: var(--text-base);
    }

    /* Specific overrides */
    .btn-filter {
      background: var(--bg-card);
    }

    /* === МЕНЕЕ АГРЕССИВНАЯ КНОПКА СБРОСА === */
    .btn-reset {
      background: var(--bg-tertiary);
      color: var(--accent-color-danger);
      border: 1px solid rgba(239, 68, 68, 0.3);
      opacity: 0.8;
    }
    .btn-reset:hover {
      background: rgba(239, 68, 68, 0.1);
      box-shadow: var(--shadow-sm);
      opacity: 1;
    }

    /* === УБРАЛИ ДУБЛИРУЮЩИЙ СТИЛЬ СБРОСА === */

    .content {
      padding: var(--space-7);
      background: var(--bg-primary);
    }

    .month {
      margin-bottom: var(--space-7);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-l);
      overflow: hidden;
      background: var(--bg-secondary);
      transition: var(--transition);
    }

    .month:hover {
      box-shadow: var(--shadow-md);
    }

    .month-header {
      background: var(--gradient-primary);
      color: white;
      padding: var(--space-7) var(--space-6);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .month-header-inner {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .month-ring {
      --p: 0;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: conic-gradient(rgba(255, 255, 255, 0.9) calc(var(--p)*1%), rgba(255,255,255,0.15) 0);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xs);
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .month-ring::after {
      content: "";
      position: absolute;
      inset: 5px;
      background: rgba(0,0,0,0.15);
      border-radius: 50%;
      backdrop-filter: blur(2px);
    }

    .month-ring span {
      position: relative;
      z-index: 2;
      color: #fff;
    }

    .month-header:hover {
      filter: brightness(1.05);
    }

    .month-title {
      font-size: var(--text-xl);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .week {
      border-bottom: 1px solid var(--border-color);
      padding: var(--space-4) 0;
    }

    .week:last-child {
      border-bottom: none;
    }

    .week-header {
      background: var(--bg-tertiary);
      padding: var(--space-5) var(--space-6);
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      transition: var(--transition);
      border-left: 3px solid transparent;
      align-items: center;
    }

    .week-header:hover {
      background: var(--bg-card);
      border-left-color: var(--accent-color);
      padding-left: calc(var(--space-6) + var(--space-1));
    }

    .week-header input.week-cb {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-color);
      margin-right: var(--space-4);
      flex: 0 0 auto;
    }

    .week-header.done {
      border-left-color: var(--accent-color-success);
    }

    .week-header:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }
    /* === ПРОГРЕСС-БАР НЕДЕЛИ (УПРОЩЕННЫЙ И ЦЕНТРИРОВАННЫЙ) === */
    .week-progress {
      --week-pad-x: var(--space-6);
      --week-cb-w: 18px;
      --week-cb-gap: var(--space-4);
      height: var(--week-progress-height);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--week-progress-radius);
      position: relative;
      overflow: hidden;
      display: block;
      margin: var(--space-5) 0;
      width: calc(100% - (var(--week-pad-x)*2) - (var(--week-cb-w) + var(--week-cb-gap)));
      margin-left: calc(var(--week-pad-x) + var(--week-cb-w) + var(--week-cb-gap));
      margin-right: var(--week-pad-x);
    }

    .week-progress span {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0;
      background: var(--gradient-primary);
      display: block;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .week-progress::after {
      content: attr(data-label);
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-secondary);
      mix-blend-mode: difference;
      pointer-events: none;
      letter-spacing: 0.3px;
    }

    .week-header.week-done .week-title-text {
      text-decoration: line-through;
      opacity: 0.65;
    }

    .week-header.week-done {
      border-left-color: var(--accent-color-success);
    }

    .week-desc {
      background: var(--bg-secondary);
      padding: var(--space-4) var(--space-6) var(--space-2) var(--space-6);
      font-size: var(--text-sm);
      line-height: 1.6;
      color: var(--text-secondary);
      border-left: 3px solid var(--accent-color);
      border-bottom: 1px solid var(--border-color);
    }

    .days {
      padding: var(--space-5);
      background: var(--bg-secondary);
    }

    .day {
      background: transparent;
      border: none;
      padding: 0;
      margin: 0 0 var(--space-4);
      transition: var(--transition);
    }

    /* === УПРОЩЕННЫЕ ХОВЕР-ЭФФЕКТЫ === */
    .interactive-element:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .day:hover {
      transform: none;
      box-shadow: none;
    }

    .day.done .day-header {
      border-color: var(--accent-color-success);
      background: rgba(34, 197, 94, 0.06);
    }

    .day.done .day-header .day-title {
      text-decoration: line-through;
      opacity: 0.65;
    }

    .day.done .day-header .day-time {
      opacity: 0.75;
      filter: saturate(0.6);
    }

    .day-header .day-title {
      transition: opacity 0.3s, text-decoration-color 0.3s;
    }

    .day-header {
      display: flex;
      gap: var(--space-3);
      margin: 0;
      align-items: center;
      cursor: pointer;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-m);
      padding: var(--space-3) var(--space-3) var(--space-3) calc(var(--space-6) + var(--space-4));
      min-height: 44px;
      position: relative;
    }

    .day-header input {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin: 0;
      accent-color: var(--accent-color);
      border-radius: var(--radius-s);
      position: absolute;
      left: var(--space-4);
      top: 50%;
      transform: translateY(-50%);
    }

    .day-header > div:first-child {
      gap: 0 !important;
    }

    .day-header:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .day-body {
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 var(--radius-m) var(--radius-m);
      padding: var(--space-4) var(--space-5) var(--space-5);
      background: var(--bg-secondary);
    }

    .day-body.collapsed {
      display: none;
    }

    .day-header.open {
      border-radius: var(--radius-m) var(--radius-m) 0 0;
    }

    .day-info {
      flex: 1;
    }

    .day-title {
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--text-primary);
      margin: 0;
      letter-spacing: 0.2px;
    }

    .day-header .day-title {
      flex: 1;
      text-align: center;
      padding-right: calc(var(--space-6) + var(--space-4));
    }

    .day-header .day-time {
      position: absolute;
      right: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
    }

    .day-time {
      display: inline-block;
      background: var(--gradient-primary);
      color: white;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-s);
      font-size: var(--text-xs);
      font-weight: 700;
      margin-left: var(--space-3);
      letter-spacing: 0.3px;
    }

    .day-task {
      color: var(--text-secondary);
      line-height: 1.8;
      margin: var(--space-3) 0;
      font-size: var(--text-sm);
    }

    /* === ЦЕЛИ И ЗАДАЧИ (УПРОЩЕННЫЙ ДИЗАЙН) === */
    .month-objectives, .week-objectives {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-m);
      padding: var(--space-3) var(--space-4);
      margin: var(--space-3) 0 var(--space-5);
    }

    .month-objectives strong, .week-objectives strong {
      color: var(--text-primary);
      font-size: var(--text-sm);
    }

    .month-objectives .mo-goal, .week-objectives .wg-goal {
      color: var(--text-secondary);
      font-size: var(--text-sm);
      line-height: 1.5;
      margin-bottom: var(--space-2);
    }

    .month-objectives ul, .week-objectives ul {
      list-style: disc;
      margin: 0 0 0 var(--space-4);
      padding: 0;
      color: var(--text-secondary);
      font-size: var(--text-xs);
      line-height: 1.4;
    }

    .day-goal-line {
      color: var(--text-secondary);
      font-size: var(--text-xs);
      margin-top: var(--space-1);
    }

    .day-tasks-list {
      list-style: square;
      margin: var(--space-2) 0 var(--space-1) var(--space-4);
      padding: 0;
      color: var(--text-secondary);
      font-size: var(--text-xs);
      line-height: 1.4;
    }

    .day-tasks-list li {
      margin: var(--space-1) 0;
    }

    /* === ТЕМНАЯ ТЕМА (УПРОЩЕНО) === */
    body[data-theme="dark"] .month-objectives ul,
    body[data-theme="dark"] .week-objectives ul,
    body[data-theme="dark"] .day-tasks-list,
    body[data-theme="dark"] .month-objectives .mo-goal,
    body[data-theme="dark"] .week-objectives .wg-goal,
    body[data-theme="dark"] .day-goal-line {
      color: var(--text-secondary);
    }

    .day-resources {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--border-color);
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
    }

    .day-resources a {
      display: inline-block;
      color: var(--accent-color);
      text-decoration: none;
      font-size: var(--text-sm);
      font-weight: 600;
      padding: var(--space-2) var(--space-4);
      background: rgba(14, 165, 233, 0.08);
      border-radius: var(--radius-m);
      border: 1px solid rgba(14, 165, 233, 0.2);
      transition: var(--transition);
    }

    .day-resources a:hover {
      background: rgba(14, 165, 233, 0.15);
      border-color: rgba(14, 165, 233, 0.4);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    /* === ДОПОЛНИТЕЛЬНЫЕ ЭЛЕМЕНТЫ (УПРОЩЕНО) === */
    .day-extra {
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px dashed var(--border-color);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .note-block textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-m);
      padding: var(--space-3) var(--space-3);
      color: var(--text-primary);
      font-family: inherit;
      font-size: var(--text-sm);
      line-height: 1.5;
      transition: var(--transition);
    }

    .note-block textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: var(--focus-ring);
    }

    .attachments-block {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .attach-links, .attach-files {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .attach-links input[type="text"], .attach-links input[type="url"] {
      flex: 1 1 180px;
      min-width: 160px;
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      border-radius: var(--radius-s);
      color: var(--text-primary);
      font-size: var(--text-xs);
    }

    .attach-links button, .user-links button, .user-files button {
      background: var(--gradient-primary);
      color: #fff;
      border: none;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-s);
      font-size: var(--text-xs);
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      transition: var(--transition);
    }

    .attach-links button:hover, .user-links button:hover, .user-files button:hover {
      filter: brightness(1.05);
    }

    .user-links, .user-files {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .user-links li, .user-files li {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      background: var(--bg-secondary);
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-s);
      font-size: var(--text-xs);
    }

    .user-links li button.x-btn, .user-files li button.x-btn {
      margin-left: auto;
    }

    .user-links a {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 600;
    }
    .user-files a { color: #34d399; text-decoration: none; font-weight: 600; }
    /* Заметки (список) */
    #content .note-block ul li { background: var(--bg-secondary); border:1px solid var(--border-color); padding:6px 10px; border-radius:8px; font-size:12px; display:flex; align-items:center; gap:8px; }
    #content .note-block ul li .note-text { flex:1; color: var(--text-primary); }
  /* Кнопка удаления (уменьшена) */
  .del-btn { background: #ef4444 !important; font-size: 12px; width: 26px; height: 26px; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; box-shadow: 0 2px 6px rgba(239,68,68,.25); }
  .del-btn:hover { filter: brightness(1.15); transform: translateY(-2px); }
    .file-size { color: var(--text-muted); font-size: 11px; margin-left: auto; }
    .attach-hint { font-size: 11px; color: var(--text-muted); }
    .inline-badge { background: rgba(139,92,246,.15); color: #a78bfa; font-size: 10px; padding: 2px 6px; border-radius: 6px; font-weight: 600; letter-spacing: .5px; }
  /* Кнопка материалов — улучшенный стиль */
  .materials-toggle { margin-top: 10px; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; font-weight: 600; background: linear-gradient(135deg, rgba(139,92,246,.35), rgba(167,139,250,.2)); color: #c4b5fd; padding: 6px 14px 6px 10px; border-radius: 18px; border: 1px solid rgba(167,139,250,.55); transition: background .35s, box-shadow .35s, border-color .35s; position: relative; }
  .materials-toggle:hover { background: linear-gradient(135deg, rgba(139,92,246,.5), rgba(167,139,250,.32)); box-shadow: 0 4px 14px var(--glow); }
  .materials-toggle.open { background: linear-gradient(135deg, rgba(139,92,246,.6), rgba(167,139,250,.45)); color: #fff; }
  .materials-toggle span.arrow { transition: transform .35s cubic-bezier(.4,0,.2,1); display: inline-block; font-size: 13px; }
  .materials-toggle.open span.arrow { transform: rotate(90deg); }
  .materials-toggle .mat-badges { display: inline-flex; gap: 4px; margin-left: 4px; }
  .mat-badge { background: rgba(0,0,0,.25); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; line-height: 1; font-weight: 600; letter-spacing: .5px; display: inline-flex; align-items: center; gap: 2px; }
  .mat-badge.link { background: rgba(96,165,250,.35); color: #bfdbfe; }
  .mat-badge.file { background: rgba(52,211,153,.35); color: #d1fae5; }
  .mat-badge.note { background: rgba(251,191,36,.35); color: #fef3c7; }
  .materials-toggle.open .mat-badge { filter: brightness(1.15); }
  /* Анимация появления дополнительного блока */
  .day-extra { animation: none; }
  .day-extra.fade-in { animation: fadeSlide .35s ease; }
  @keyframes fadeSlide { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
  .day-extra.collapsed { display: none; }
  /* Внутренние раскрывающиеся секции (подзадачи, заметки, вложения) */
  .section-toggle { width:100%; text-align:left; background: var(--bg-card); color: var(--text-secondary); padding:8px 12px; border:1px solid var(--border-color); border-radius:8px; font-size:12px; font-weight:600; letter-spacing:.5px; display:flex; align-items:center; gap:6px; cursor:pointer; transition:.25s; }
  .section-toggle:hover { background: var(--bg-tertiary); }
  .section-toggle.open { background: var(--bg-card); color: var(--text-secondary); }
  .section-toggle .arrow { display:none; }
  .section-toggle.open .arrow { display:none; }
  .section-body { margin-top:8px; }
  .section-body.collapsed { display:none; }
  .st-progress { margin-left:auto; background:rgba(0,0,0,.25); padding:2px 6px; border-radius:6px; font-size:10px; font-weight:700; color:#fff; }
  .section-toggle.open .st-progress { background:rgba(255,255,255,.25); }
  /* Подзадачи внутри дня */
  .day-subtasks { margin: 4px 0 10px; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; }
  .day-subtasks h5 { margin: 0 0 8px; font-size: 12px; letter-spacing: .5px; font-weight: 700; color: var(--text-secondary); display:flex; align-items:center; gap:6px; }
  .subtask-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 6px; }
  .subtask-item { display:flex; align-items:center; gap:8px; font-size:12px; }
  .subtask-item input[type="checkbox"] { cursor:pointer; accent-color:var(--accent-color-accent); width:18px; height:18px; flex:0 0 auto; }
  .subtask-box { flex:1; display:flex; align-items:center; gap:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; padding:6px 10px; min-height:34px; transition:border-color .25s; }
  .subtask-item.done .subtask-box { opacity:.65; text-decoration:line-through; }
  .subtask-box:hover { border-color:var(--accent-color-accent); }
  .subtask-box button { background:none; border:none; color:var(--text-secondary); font-size:14px; padding:2px 6px; border-radius:4px; cursor:pointer; line-height:1; }
  .subtask-box button { background:none; border:none; color:var(--text-secondary); font-size:14px; padding:2px 6px; border-radius:4px; cursor:pointer; line-height:1; }
  .subtask-box button:hover { color:#ef4444; background:rgba(239,68,68,.08); }
  [data-theme="dark"] .subtask-box button { color:var(--text-muted); }
  [data-theme="dark"] .subtask-box button:hover { color:#f87171; }
  .subtask-box span { flex:1; }
  .subtask-box span { color: var(--text-primary); }
  .subtask-item.done .subtask-box span { color: var(--text-muted); }
  .subtask-box .sys-badge { font-size:9px; font-weight:600; letter-spacing:.5px; background:rgba(139,92,246,.25); color:#c4b5fd; padding:2px 5px; border-radius:6px; }
  .x-btn { background:none !important; border:none !important; color:var(--text-secondary); font-size:14px; padding:2px 6px; cursor:pointer; line-height:1; border-radius:4px; }
  .x-btn:hover { color:#ef4444; background:rgba(239,68,68,.08); }
  [data-theme="dark"] .x-btn { color:var(--text-muted); }
  [data-theme="dark"] .x-btn:hover { color:#f87171; }
  .add-subtask { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
  .add-subtask input { flex: 1 1 160px; min-width: 140px; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-size: 12px; }
  .add-subtask button { background: var(--gradient-primary); color: #fff; border: none; padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; }
  .add-subtask button:hover { filter: brightness(1.1); }
  .add-subtask button:focus-visible { outline:none; box-shadow: var(--focus-ring); }
  /* Стилизация file input */
  .file-wrapper { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  .file-wrapper input[type="file"] { display: none; }
  .file-btn { background: var(--gradient-accent); color: #fff; padding: 8px 16px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 4px 12px var(--shadow-color); transition: .3s; }
  .file-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
  .file-btn:active { transform: translateY(0); }
  .attach-links button { width: 42px; justify-content: center; padding: 8px 0; }
  .attach-hint { flex: 1 1 100%; }
    @media (max-width: 600px){
      .attach-links input[type="text"], .attach-links input[type="url"] { flex: 1 1 100%; }
      .attach-links { flex-direction: column; }
    }

    .collapsed {
      display: none;
    }

    /* Плавающая панель быстрых действий */
    .quick-panel { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 200;
      opacity:0; pointer-events:none; transform: translateY(14px) scale(.96);
      transition: opacity .55s ease, transform .55s cubic-bezier(.4,0,.2,1);
      will-change: opacity, transform; }
    .quick-panel.visible { opacity:1; pointer-events:auto; transform: translateY(0) scale(1); }
    .qp-btn { background: var(--accent-gradient-faded); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.15); color: var(--text-primary); font-size:12px; font-weight:600; padding:10px 16px; border-radius: 18px; cursor:pointer; display:flex; align-items:center; gap:6px; transition: var(--transition); }
    .qp-btn:hover { background: var(--gradient-primary); color:#fff; box-shadow:0 8px 24px var(--glow); }
    .qp-btn:focus-visible { outline:none; box-shadow: var(--focus-ring); }
    @media (max-width: 880px){ .quick-panel { right:12px; bottom:12px; } .qp-btn { padding:8px 12px; font-size:11px; } }
  .qp-small { font-size:10px; background: var(--bg-secondary); opacity:.85; }
  .storage-usage { background: var(--bg-tertiary); border:1px solid var(--border-color); padding:4px 8px; border-radius:10px; font-size:10px; font-weight:600; color: var(--text-secondary); display:flex; gap:6px; align-items:center; }
  .storage-usage-bar { flex:1; height:6px; background: var(--bg-card); border-radius:4px; overflow:hidden; position:relative; }
  .storage-usage-bar span { position:absolute; inset:0; width:0; background: linear-gradient(90deg, var(--accent-color), var(--accent-color-accent), var(--accent-color-alt)); transition: width .6s ease; }
  .storage-tooltip { position:absolute; background:rgba(15,18,28,0.92); color:var(--text-secondary); font-size:11px; white-space:pre; padding:10px 12px; border:1px solid rgba(255,255,255,0.1); border-radius:10px; z-index:9999; line-height:1.4; font-weight:500; backdrop-filter:blur(12px); box-shadow:0 8px 24px -8px rgba(0,0,0,.55); max-width:260px; pointer-events:none; }
  /* Облачная синхронизация */
  .cloud-panel { padding: 12px 32px 0; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  .cloud-badge { font-size:11px; font-weight:600; background: linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); padding:6px 12px; border:1px solid rgba(255,255,255,0.08); border-radius:18px; display:flex; align-items:center; gap:6px; position:relative; overflow:hidden; }
  .cloud-badge::after { content:""; position:absolute; inset:0; background:radial-gradient(circle at 20% 15%, rgba(255,255,255,0.12), transparent 70%); opacity:.6; pointer-events:none; }
  .cloud-btn { position:relative; background: linear-gradient(140deg, rgba(123,91,255,0.18), rgba(255,78,205,0.16)); border:1px solid rgba(255,255,255,0.12); color: var(--text-primary); font-size:11px; font-weight:600; padding:9px 16px; border-radius:14px; cursor:pointer; display:flex; align-items:center; gap:6px; transition: all .35s cubic-bezier(.4,0,.2,1); backdrop-filter: blur(10px); }
  .cloud-btn::before { content:""; position:absolute; inset:0; border-radius:inherit; background:linear-gradient(160deg, rgba(255,255,255,0.18), rgba(255,255,255,0)); opacity:.35; mix-blend-mode:overlay; transition:inherit; }
  .cloud-btn:hover { background: linear-gradient(140deg, #7b5bff, #ff4ecd 55%, #3da6ff); color:#fff; box-shadow:0 8px 28px -6px rgba(123,91,255,.55), 0 4px 14px -4px rgba(255,78,205,.45); transform:translateY(-3px); }
  .cloud-btn:active { transform:translateY(-1px) scale(.97); }
  .cloud-btn:focus-visible { outline:none; box-shadow:0 0 0 3px rgba(123,91,255,.5), 0 0 0 5px rgba(255,255,255,.12); }
  .cloud-btn:disabled { opacity:.4; cursor:not-allowed; }
  .cloud-status-ok { color:#34d399; }
  .cloud-status-err { color:#f87171; }
  .cloud-status-warn { color:#fbbf24; }
  .cloud-last { font-size:10px; color: var(--text-muted); margin-left:auto; }
  .cloud-warn { flex:1 1 100%; background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.4); color:#fca5a5; padding:6px 10px; border-radius:10px; font-size:11px; font-weight:600; }
  /* Google sign-in button compact */
  .cloud-btn-g { width:42px; padding:8px !important; display:flex; align-items:center; justify-content:center; }
  .cloud-btn-g .g-icon { width:20px; height:20px; display:block; }
  .cloud-btn-g svg { width:100%; height:100%; display:block; }
  .cloud-g-btn { width:44px; height:44px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.1); background: linear-gradient(150deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); border-radius:16px; cursor:pointer; transition: all .35s cubic-bezier(.4,0,.2,1); position:relative; overflow:hidden; backdrop-filter: blur(10px); }
  .cloud-g-btn::after { content:""; position:absolute; inset:0; background:radial-gradient(circle at 30% 25%, rgba(255,255,255,0.25), transparent 65%); opacity:.4; transition:inherit; }
  .cloud-g-btn.full { padding:0 18px; width:auto; gap:10px; font-size:12px; font-weight:600; letter-spacing:.4px; }
  .cloud-g-btn.full .g-ic { width:18px; height:18px; display:inline-block; }
  .cloud-g-btn:hover { background: linear-gradient(150deg, rgba(123,91,255,0.25), rgba(255,78,205,0.25)); box-shadow:0 10px 32px -8px rgba(123,91,255,.6), 0 6px 18px -6px rgba(255,78,205,.5); transform:translateY(-3px); }
  .cloud-g-btn:focus-visible { outline:none; box-shadow: var(--focus-ring); }
  .cloud-g-btn svg { width:22px; height:22px; display:block; }
  .cloud-g-btn.signout { background: linear-gradient(145deg,#ff4d61,#ff8a47); color:#fff; font-weight:700; font-size:12px; letter-spacing:.55px; box-shadow: 0 6px 18px -4px rgba(255,77,97,.55); }
  .cloud-g-btn.signout::after { background: radial-gradient(circle at 65% 35%, rgba(255,255,255,0.35), transparent 70%); }
  .cloud-g-btn.signout:hover { background: linear-gradient(145deg,#ff5d70,#ff9a57); box-shadow:0 12px 38px -10px rgba(255,77,97,.7), 0 6px 20px -6px rgba(255,138,71,.55); filter:brightness(1.05); }
  .cloud-g-btn.signout:active { transform:translateY(-1px) scale(.97); }

  /* Mini icon pill buttons */
  .cloud-mini-btn { width:42px; height:42px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.1); background: linear-gradient(160deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03)); border-radius:14px; cursor:pointer; font-size:17px; line-height:1; transition: all .35s cubic-bezier(.4,0,.2,1); position:relative; backdrop-filter: blur(10px); }
  .cloud-mini-btn::before { content:""; position:absolute; inset:0; border-radius:inherit; background:linear-gradient(140deg, rgba(123,91,255,0.4), rgba(255,78,205,0)); opacity:0; transition:inherit; }
  .cloud-mini-btn:hover { color:#fff; transform:translateY(-3px); box-shadow:0 10px 26px -8px rgba(123,91,255,.55), 0 6px 14px -6px rgba(255,78,205,.45); }
  .cloud-mini-btn:hover::before { opacity:1; }
  .cloud-mini-btn:active { transform:translateY(-1px) scale(.97); }
  .cloud-mini-btn:focus-visible { outline:none; box-shadow:0 0 0 3px rgba(123,91,255,.5), 0 0 0 5px rgba(255,255,255,.15); }
  .cloud-mini-btn:disabled { opacity:.4; cursor:not-allowed; }

  /* State color variations for mini buttons (optional) */
  .cloud-mini-btn.save { background: linear-gradient(150deg, rgba(46,230,168,.15), rgba(61,173,255,.12)); }
  .cloud-mini-btn.restore { background: linear-gradient(150deg, rgba(255,180,71,.18), rgba(255,78,205,.1)); }
  .cloud-mini-btn.save:hover { box-shadow:0 10px 24px -8px rgba(46,230,168,.55), 0 6px 14px -6px rgba(61,173,255,.4); }
  .cloud-mini-btn.restore:hover { box-shadow:0 10px 24px -8px rgba(255,180,71,.55), 0 6px 14px -6px rgba(255,78,205,.4); }
  /* Минималистичный индикатор облака */
  .cloud-panel.minimalist { padding:8px 32px 0; gap:14px; }
  .cloud-indicator { position:relative; display:inline-flex; align-items:center; gap:10px; background: linear-gradient(155deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03)); border:1px solid rgba(255,255,255,0.12); padding:10px 18px; border-radius:24px; font-size:12px; font-weight:600; cursor:pointer; color: var(--text-secondary); transition: all .4s cubic-bezier(.4,0,.2,1); backdrop-filter: blur(14px); }
  .cloud-indicator::before { content:""; position:absolute; inset:0; border-radius:inherit; background:radial-gradient(circle at 18% 22%, rgba(123,91,255,0.4), transparent 70%); opacity:.35; mix-blend-mode:screen; pointer-events:none; }
  .cloud-indicator:hover { background: linear-gradient(155deg, rgba(123,91,255,0.35), rgba(255,78,205,0.3)); color: var(--text-primary); box-shadow:0 14px 38px -12px rgba(123,91,255,.6), 0 8px 24px -10px rgba(255,78,205,.5); transform:translateY(-3px); }
  .cloud-indicator:focus-visible { outline:none; box-shadow: var(--focus-ring); }
  .cloud-indicator svg { opacity:.9; }
  .cloud-dot { width:12px; height:12px; border-radius:50%; background:#ff4d61; box-shadow:0 0 0 5px rgba(255,77,97,.22); position:relative; overflow:hidden; }
  .cloud-dot::after { content:""; position:absolute; inset:0; background:radial-gradient(circle at 40% 35%, rgba(255,255,255,0.85), rgba(255,255,255,0)); opacity:.55; }
  .cloud-dot.state-ok { background:#2ee6a8; box-shadow:0 0 0 5px rgba(46,230,168,.28); }
  .cloud-dot.state-warn { background:#ffb347; box-shadow:0 0 0 5px rgba(255,179,71,.30); }
  .cloud-dot.state-off { background:#ff4d61; box-shadow:0 0 0 5px rgba(255,77,97,.25); }
  .cloud-dot.state-pending { background:#3da6ff; box-shadow:0 0 0 5px rgba(61,166,255,.30); }
  @keyframes pulseCloud { 0%{ transform:scale(1); opacity:1;} 50%{ transform:scale(1.45); opacity:.35;} 100%{ transform:scale(1); opacity:1;} }
  .cloud-dot.pulse::after { content:""; position:absolute; inset:0; border-radius:inherit; background:currentColor; animation:pulseCloud 1.4s ease-in-out infinite; filter:blur(2px); opacity:.5; }
  .cloud-hint { font-size:11px; font-weight:600; letter-spacing:.5px; text-transform:uppercase; color: var(--text-muted); }
  .cloud-indicator.synced .cloud-hint { color:#34d399; }
  .cloud-indicator.warn .cloud-hint { color:#fbbf24; }
  .cloud-indicator.off .cloud-hint { color:#f87171; }

    /* Плавное раскрытие внутренних секций */
    .section-body { overflow: hidden; transition: max-height .45s ease; }
    .section-body.collapsed { max-height: 0 !important; padding-top:0 !important; }
    .section-body:not(.collapsed) { max-height: 800px; }

    @media (max-width: 768px) {
      .stats {
        grid-template-columns: 1fr 1fr;
      }

      .month-title {
        font-size: 1.4em;
      }

      .header h1 {
        font-size: 2em;
      }

      .header {
        padding: 40px 24px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <button class="theme-toggle" onclick="toggleTheme()" title="Переключить тему">🌓</button>
      <h1>Премиальный трекер обучения фронтенду</h1>
      <p>Революционный подход к изучению веб-разработки за 8 месяцев • 196 дней к экспертности</p>
    </div>

    <div class="stats">
      <div class="stat">
        <h3>Общие дни</h3>
        <div class="num">196</div>
      </div>
      <div class="stat">
        <h3>Завершено</h3>
        <div class="num" id="done">0</div>
      </div>
      <div class="stat">
        <h3>В процессе</h3>
        <div class="num" id="left">196</div>
      </div>
      <div class="stat">
        <h3>Прогресс</h3>
        <div class="num" id="pct">0%</div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="bar" style="width: 0%">0%</div>
    </div>

    <div class="cloud-panel minimalist">
      <div class="cloud-indicator" id="cloudStatus" role="button" tabindex="0" title="Облако" aria-label="Статус облака" onclick="cloudIndicatorClick(event)" onkeydown="if(event.key==='Enter') cloudIndicatorClick(event)">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M19.36 10.46C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h12.5c3.04 0 5.5-2.46 5.5-5.5 0-2.89-2.27-5.27-5.14-5.54z"/></svg>
        <span class="cloud-dot" id="cloudDot"></span>
        <span class="cloud-hint" id="cloudHint"></span>
      </div>
  <button class="cloud-g-btn full interactive-element" id="cloudGoogleBtn" type="button" aria-label="Войти через Google" title="Войти через Google"></button>
      <button class="cloud-mini-btn" id="cloudBackupBtn" type="button" aria-label="Быстрый бэкап" title="Экспорт JSON" onclick="quickBackup()">💾</button>
      <button class="cloud-mini-btn" id="cloudRestoreBtn" type="button" aria-label="Восстановить" title="Восстановить из локальной истории" onclick="restoreLastSnapshot()">⟲</button>
      <div class="cloud-last" id="cloudLastSync" aria-live="polite"></div>
    </div>

    <div style="padding:0 32px 8px; display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
      <div class="storage-usage" id="storageUsage">
        <span>Хранилище</span>
        <div class="storage-usage-bar"><span id="storageUsageBar"></span></div>
        <strong id="storageUsagePct">0%</strong>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px;">
  <button class="qp-btn qp-small interactive-element" type="button" onclick="exportData()">⬇️ Экспорт</button>
  <button class="qp-btn qp-small interactive-element" type="button" onclick="document.getElementById('importInput').click()">⬆️ Импорт</button>
        <input type="file" id="importInput" accept="application/json" style="display:none" onchange="handleImport(this)">
      </div>
    </div>

    <div class="categories-summary" id="categoriesSummary"></div>

    <div class="content" id="content"></div>
  </div>
  <div class="quick-panel" aria-label="Быстрые действия">
  <button class="qp-btn interactive-element" type="button" onclick="scrollToNextIncomplete()">➡️ Следующий</button>
  <button class="qp-btn interactive-element" type="button" onclick="expandAll()">🔓 Открыть все</button>
  <button class="qp-btn interactive-element" type="button" onclick="collapseAll()">🔒 Свернуть все</button>
  <button class="qp-btn interactive-element" type="button" onclick="resetFilter()">🎯 Сброс фильтра</button>
  </div>

  <script>
    /* === Firebase Cloud Sync (анонимная) === */
    // === Реальная конфигурация Firebase (заменена) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCo560tNWLd4OqoTMc8g0DgxvsfFldMNWU",
      authDomain: "tracker-397f9.firebaseapp.com",
      projectId: "tracker-397f9",
      storageBucket: "tracker-397f9.appspot.com", // исправлено: используем *.appspot.com
      messagingSenderId: "578524159971",
      appId: "1:578524159971:web:7fbb385e5063ebac25cad6",
      measurementId: "G-2PD3FS0WCS" // не используется напрямую (analytics не подключаем)
    };
    // (Проверка плейсхолдеров удалена: конфигурация заполнена)
  let firebaseLoaded=false, auth=null, db=null, cloudUser=null, remoteSnapshotMeta=null, cloudSyncPending=false;
  let lastUploadedHash=null, lastUploadAt=0, cloudRetry=0; // минимизация лишних записей
  let historyBuffer=[]; const HISTORY_KEY='historySnapshotsV1'; const HISTORY_LIMIT=10;
  (function loadHistory(){ try{ historyBuffer=JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); } catch(_){ historyBuffer=[]; } })();
    function loadFirebaseCompat(){
      if(firebaseLoaded) return Promise.resolve();
      const scripts=[
        'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js',
        'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js',
        'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js'
      ];
      return scripts.reduce((p,src)=>p.then(()=>new Promise((res,rej)=>{const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s);})),Promise.resolve())
        .then(()=>{ firebase.initializeApp(firebaseConfig); firebaseLoaded=true; initCloud(); })
        .catch(e=>console.warn('Firebase load error',e));
    }
    function initCloud(){
      try {
        auth=firebase.auth();
        db=firebase.firestore();
        // Явно задаём LOCAL персистентность (по умолчанию так и есть, но делаем явно для предсказуемости)
        if(auth.setPersistence){
          auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.warn('Persistence set error', e));
        }
        let redirectHandled=false;
        // Обработка возможного redirect-входа (fallback сценарий)
        auth.getRedirectResult().then(res=>{
          if(res && res.user){
            localStorage.setItem('cloudWasSignedIn','1');
            // onAuthStateChanged тоже сработает, но на случай порядка вызываем обновление
            if(!redirectHandled){ redirectHandled=true; initialCloudSync(); updateCloudUI(); }
          }
        }).catch(err=>{
          if(err && err.code !== 'auth/no-auth-event') console.warn('Redirect result error', err);
        });
        auth.onAuthStateChanged(u=>{
          cloudUser=u;
          if(u){
            // Сохраняем маркер, чтобы при перезагрузке авто-подгрузить Firebase
            localStorage.setItem('cloudWasSignedIn','1');
            fetchRemoteMeta();
          } else {
            // Если пользователь вышел — убираем маркер
            localStorage.removeItem('cloudWasSignedIn');
          }
          updateCloudUI();
        });
      } catch(e){ console.warn('Cloud init error',e); }
    }
    // ==== Аутентификация (Google + аноним) ====
    function cloudAnonSignIn(){ loadFirebaseCompat().then(()=>{ if(!auth) return; if(cloudUser){ alert('Уже вошли'); return;} auth.signInAnonymously().catch(e=>alert('Ошибка входа: '+e.message)); }); }
    function cloudGoogleSignIn(){
      loadFirebaseCompat().then(()=>{
        if(!auth) return;
        const provider = new firebase.auth.GoogleAuthProvider();
        const FALLBACK_CODES = new Set(['auth/popup-closed-by-user','auth/popup-blocked','auth/cancelled-popup-request']);
        const useRedirectFallback = (err)=>{
          if(FALLBACK_CODES.has(err.code)){
            if(sessionStorage.getItem('redirectTried')) return; // избежать цикла
            sessionStorage.setItem('redirectTried','1');
            if(confirm('Окно входа не завершилось ("'+err.code+'"). Попробовать вход через перенаправление?')){
              auth.signInWithRedirect(provider).catch(e=>alert('Redirect вход не удался: '+e.message));
            }
          }
        };
        if(auth.currentUser && auth.currentUser.isAnonymous){
          auth.currentUser.linkWithPopup(provider)
            .then(()=>{ localStorage.setItem('cloudWasSignedIn','1'); initialCloudSync(); updateCloudUI(); console.log('[Auth] Linked anonymous -> Google'); })
            .catch(err=>{
              if(err.code === 'auth/credential-already-in-use'){
                auth.signInWithPopup(provider)
                  .then(()=>{ localStorage.setItem('cloudWasSignedIn','1'); cloudMerge(); updateCloudUI(); console.log('[Auth] Recovered existing Google credential'); })
                  .catch(e=>{
                    if(e.code === 'auth/unauthorized-domain'){
                      alert('Домен не авторизован. Добавьте '+location.hostname+' в Firebase Authentication → Authorized domains.');
                    } else if(FALLBACK_CODES.has(e.code)){
                      useRedirectFallback(e);
                    } else if(e.code === 'auth/popup-closed-by-user'){
                      alert('Окно входа закрыто. Повторите попытку.');
                    } else {
                      alert('Ошибка входа: '+e.message);
                    }
                  });
              } else if(FALLBACK_CODES.has(err.code)){
                useRedirectFallback(err);
              } else if(err.code === 'auth/popup-closed-by-user'){
                alert('Окно входа закрыто. Повторите попытку.');
              } else {
                alert('Ошибка связывания: '+err.message);
              }
            });
        } else {
          auth.signInWithPopup(provider)
            .then(()=>{ localStorage.setItem('cloudWasSignedIn','1'); initialCloudSync(); updateCloudUI(); console.log('[Auth] Signed in with Google'); })
            .catch(e=>{
              if(e.code === 'auth/unauthorized-domain'){
                console.warn('[Firebase] Unauthorized domain.');
                alert('Домен не авторизован для OAuth. Добавьте "'+location.hostname+'" в Firebase Console → Authentication → Authorized domains.');
              } else if(FALLBACK_CODES.has(e.code)){
                useRedirectFallback(e);
              } else if(e.code === 'auth/popup-closed-by-user'){
                alert('Окно авторизации закрыто. Повторите попытку.');
              } else {
                alert('Ошибка входа: '+e.message);
              }
            });
        }
      });
    }
    function cloudSignIn(){ cloudGoogleSignIn(); }
  function cloudSignOut(){ if(auth && cloudUser) auth.signOut().finally(()=>{ localStorage.removeItem('cloudWasSignedIn'); cloudUser=null; updateCloudUI(); }); }
    function snapshotLocal(){ return { version:2, exportedAt:new Date().toISOString(), state, notesState, attachmentsState, subtasksState, extraOpen, openState, sectionOpen, theme: document.body.getAttribute('data-theme') }; }
  function hashSnapshotStr(str){ let h=0,i=0; for(; i<str.length; i++){ h=(h*31 + str.charCodeAt(i))|0; } return h.toString(16); }
  function maybeStoreHistory(force=false){ try { const snap=snapshotLocal(); const str=JSON.stringify(snap); const h=hashSnapshotStr(str); const now=Date.now(); const last=historyBuffer[0]; if(force || !last || last.hash!==h){ historyBuffer.unshift({ts:now, hash:h, data:snap}); if(historyBuffer.length>HISTORY_LIMIT) historyBuffer.pop(); localStorage.setItem(HISTORY_KEY, JSON.stringify(historyBuffer)); } } catch(e){ console.warn('history error',e);} }
  function quickBackup(){ const data=snapshotLocal(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); const ts=new Date().toISOString().replace(/[:T]/g,'-').split('.')[0]; a.href=URL.createObjectURL(blob); a.download='learning-backup-'+ts+'.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); maybeStoreHistory(true); flashIndicator(); }
  function restoreLastSnapshot(){ if(!historyBuffer.length){ alert('История пуста'); return;} if(!confirm('Восстановить последнее сохранённое состояние? Текущее перезапишется.')) return; applySnapshot(historyBuffer[0].data); cloudSyncPending=true; scheduleCloudUpload(); }
  function flashIndicator(){ const ind=document.getElementById('cloudStatus'); if(ind){ ind.classList.add('flash-ok'); setTimeout(()=>ind.classList.remove('flash-ok'),900); } }
    function applySnapshot(obj){ if(!obj) return; if(obj.state) state=obj.state; if(obj.notesState) notesState=obj.notesState; if(obj.attachmentsState) attachmentsState=obj.attachmentsState; if(obj.subtasksState) subtasksState=obj.subtasksState; if(obj.extraOpen) extraOpen=obj.extraOpen; if(obj.openState) openState=obj.openState; if(obj.sectionOpen) sectionOpen=obj.sectionOpen; if(obj.theme){ document.body.setAttribute('data-theme', obj.theme); localStorage.setItem('theme', obj.theme);} save(); saveNotes(); saveAttachments(); saveSubtasks(); saveExtraOpen(); saveOpenState(); saveSectionOpen(); updateStats(); render(); }
    function docRef(){ if(!cloudUser) return null; return db.collection('users').doc(cloudUser.uid); }
  // === Экономная синхронизация (один документ, хэш, адаптивная задержка) ===
  let cloudUploadTimer=null;
  function scheduleCloudUpload(){
    if(!cloudUser || cloudUser.isAnonymous) return; // экономим — не пишем в облако в анонимном режиме
    cloudSyncPending=true; updateCloudUI();
    if(cloudUploadTimer) clearTimeout(cloudUploadTimer);
    const now=Date.now();
    const since = now - lastUploadAt;
    // Чем дольше не было синка — тем быстрее следующий; иначе увеличиваем интервал
    let delay = since > 120000 ? 1200 : since > 30000 ? 2500 : 4000;
    cloudUploadTimer = setTimeout(()=>cloudUpload(), delay);
  }
  function cloudUpload(){
    if(!cloudUser || cloudUser.isAnonymous){ cloudSyncPending=false; updateCloudUI(); return; }
    if(!navigator.onLine){ // ждём online
      window.addEventListener('online', ()=>scheduleCloudUpload(), { once:true });
      return;
    }
    try {
      const snapObj = snapshotLocal();
      const str = JSON.stringify(snapObj);
      const h = hashSnapshotStr(str);
      if(h === lastUploadedHash){ cloudSyncPending=false; updateCloudUI(); return; }
      const ref = docRef(); if(!ref){ cloudSyncPending=false; updateCloudUI(); return; }
      ref.set({ snapshot: snapObj, hash:h, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:false })
        .then(()=>{
          lastUploadedHash=h; lastUploadAt=Date.now(); cloudRetry=0; cloudSyncPending=false; localStorage.setItem('cloudLastSync', String(Date.now())); maybeStoreHistory(); flashIndicator(); updateCloudUI(); })
        .catch(err=>{
          console.warn('Upload fail', err); cloudRetry++; const backoff=Math.min(30000, 1000*Math.pow(2, cloudRetry)); setTimeout(()=>scheduleCloudUpload(), backoff); });
    } catch(e){ console.warn('cloudUpload error', e); cloudSyncPending=false; updateCloudUI(); }
  }
  function fetchRemoteMeta(){
    if(!cloudUser || cloudUser.isAnonymous) return;
    const ref = docRef(); if(!ref) return;
    ref.get().then(doc=>{
      if(doc.exists){
        const d = doc.data();
        if(d.updatedAt && d.hash){
          const ts = d.updatedAt.toDate ? d.updatedAt.toDate() : new Date();
          remoteSnapshotMeta={ updatedAt: ts, hash:d.hash };
          // Если наш локальный lastUploadedHash не совпадает и удалёнка свежее — обозначим STALE
          updateCloudUI();
        }
      } else {
        remoteSnapshotMeta=null; updateCloudUI();
      }
    }).catch(e=>console.warn('fetchRemoteMeta error', e));
  }
  function initialCloudSync(){
    if(!cloudUser || cloudUser.isAnonymous){ return; }
    const ref = docRef(); if(!ref) return;
    ref.get().then(doc=>{
      if(doc.exists){
        const d=doc.data();
        const ts = d.updatedAt?.toDate ? d.updatedAt.toDate() : new Date();
        remoteSnapshotMeta={ updatedAt: ts, hash:d.hash};
        // Решение: если удалёнка свежее локального lastSync или локальный пуст — берём облако
        const localSyncTs = parseInt(localStorage.getItem('cloudLastSync')||'0');
        if(!localSyncTs || (ts.getTime() > localSyncTs + 2000)){
          if(d.snapshot){ applySnapshot(d.snapshot); }
          lastUploadedHash = d.hash || null;
          localStorage.setItem('cloudLastSync', String(Date.now()));
        } else {
          // Локал свежее → загрузим локальное в облако (создаём новую версию)
          scheduleCloudUpload();
        }
      } else {
        // Документа нет — создаём первый upload
        scheduleCloudUpload();
      }
    }).catch(e=>console.warn('initialCloudSync error', e));
  }
  function cloudMerge(){ // простая стратегия: всегда берём облако
    if(!cloudUser || cloudUser.isAnonymous) return;
    const ref=docRef(); if(!ref) return;
    ref.get().then(doc=>{
      if(doc.exists){ const d=doc.data(); if(d.snapshot){ applySnapshot(d.snapshot); lastUploadedHash=d.hash||null; localStorage.setItem('cloudLastSync', String(Date.now())); updateCloudUI(); } }
    });
  }
  function cloudIndicatorClick(ev){
    if(!cloudUser){ cloudGoogleSignIn(); return; }
    if(cloudUser.isAnonymous){ cloudGoogleSignIn(); return; }
    // Если метка STALE → предложить подтянуть облако
    const hint=document.getElementById('cloudHint');
    if(hint && hint.textContent==='STALE'){
      if(confirm('В облаке есть более свежая версия. Загрузить её (локальное будет перезаписано)?')){ cloudMerge(); }
      else if(confirm('Отправить локальную версию в облако, перезаписав облачную?')){ scheduleCloudUpload(); }
    } else if(hint && hint.textContent==='OK'){
      // Принудительное сохранение
      scheduleCloudUpload();
    } else if(hint && hint.textContent==='OFF'){
      cloudGoogleSignIn();
    }
  }
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ fetchRemoteMeta(); } });
  window.addEventListener('online', ()=>{ if(cloudSyncPending) scheduleCloudUpload(); });
    // ==== Конец блока Firebase ====
    // Инициализация состояния из localStorage или пустой объект
    let state = {};
    if (localStorage.getItem('frontendPlan')) {
      try {
        state = JSON.parse(localStorage.getItem('frontendPlan')) || {};
      } catch (e) {
        state = {};
      }
    }

    const plan = [
      // Месяц 1
      {
        month: 1, title: "Месяц 1. Основы веб-разработки", weeks: [
          {
            week: 1, title: "Неделя 1 — Интернет, HTTP, DNS", days: [
              { day: 1, title: "Как работает интернет", time: "2 ч", task: "Принципы работы сети, клиент ↔ сервер, создайте конспект.", links: ["MDN — Internet||https://developer.mozilla.org/ru/docs/Learn/Common_questions/Web_mechanics/How_does_the_Internet_work"] },
              { day: 2, title: "HTTP основы", time: "2 ч", task: "Методы, коды статуса, заголовки. Разбор вкладки Network.", links: ["MDN — HTTP overview||https://developer.mozilla.org/ru/docs/Web/HTTP/Overview"] },
              { day: 3, title: "DNS и домены", time: "2 ч", task: "Что такое DNS, доменное имя, поиск IP через nslookup/dig.", links: ["MDN — DNS||https://developer.mozilla.org/ru/docs/Glossary/DNS"] },
              { day: 4, title: "Хостинг и публикация", time: "2 ч", task: "Публикация HTML страницы на GitHub Pages.", links: ["GitHub Pages||https://pages.github.com/"] },
              { day: 5, title: "Как работает браузер", time: "2 ч", task: "Разбор рендера: парсинг, DOM, CSSOM, DevTools панели.", links: ["How browsers work||https://web.dev/articles/howbrowserswork"] },
              { day: 6, title: "Проект: Личная страница", time: "4-5 ч", task: "Статическая страница обо мне + публикация.", links: ["MDN HTML||https://developer.mozilla.org/ru/docs/Learn/HTML"] },
              { day: 7, title: "Git и терминал", time: "4-5 ч", task: "git init/add/commit/push, структура репозитория.", links: ["Git Guide||https://rogerdudler.github.io/git-guide/index.ru.html"] }
            ]
          },
          {
            week: 2, title: "Неделя 2 — Базовый HTML/CSS", days: [
              { day: 8, title: "Семантика HTML", time: "2 ч", task: "Заголовки, списки, ссылки, структура.", links: ["MDN Structuring HTML||https://developer.mozilla.org/ru/docs/Learn/HTML"] },
              { day: 9, title: "Формы", time: "2 ч", task: "input/select/textarea/label, базовая валидация атрибутами.", links: ["MDN Forms||https://developer.mozilla.org/ru/docs/Learn/Forms"] },
              { day: 10, title: "Основы CSS", time: "2 ч", task: "Селекторы, каскад, наследование, специфика.", links: ["What is CSS||https://developer.mozilla.org/ru/docs/Learn/CSS"] },
              { day: 11, title: "Box Model и Flex", time: "2 ч", task: "display, box-sizing, flex-контейнер.", links: ["Flexbox Guide||https://css-tricks.com/snippets/css/a-guide-to-flexbox/"] },
              { day: 12, title: "Адаптивность", time: "2 ч", task: "@media, относительные единицы, mobile-first.", links: ["Responsive MDN||https://developer.mozilla.org/ru/docs/Learn/CSS/CSS_layout/Responsive_Design"] },
              { day: 13, title: "Проект: Резюме", time: "4-5 ч", task: "Одностраничное CV c адаптивностью.", links: [] },
              { day: 14, title: "Шлифовка резюме", time: "4-5 ч", task: "Якоря, плавный скролл, улучшение типографики.", links: [] }
            ]
          },
          {
            week: 6, title: "Неделя 6 — Объекты и DOM", days: [
              { day: 36, title: "Объекты/JSON", time: "2 ч", task: "Создание, доступ, сериализация JSON.", links: [] },
              { day: 37, title: "Массивы объектов", time: "2 ч", task: "filter/find/sort практические примеры.", links: [] },
              { day: 38, title: "DOM Введение", time: "2 ч", task: "querySelector/createElement.", links: [] },
              { day: 39, title: "События", time: "2 ч", task: "addEventListener, предотвращение перезагрузки.", links: [] },
              { day: 40, title: "Манипуляция классами", time: "2 ч", task: "classList.toggle для теминга.", links: [] },
              { day: 41, title: "Расширение To-Do", time: "4-5 ч", task: "Фильтр: все/активные/выполненные.", links: [] },
              { day: 42, title: "Отладка", time: "4-5 ч", task: "Breakpoint, Sources, stack trace.", links: [] }
            ]
          },
          {
            week: 7, title: "Неделя 7 — Асинхронность", days: [
              { day: 43, title: "Таймеры", time: "2 ч", task: "setTimeout/setInterval счетчик.", links: [] },
              { day: 44, title: "Promises", time: "2 ч", task: "Создание/цепочки then/catch.", links: [] },
              { day: 45, title: "Fetch API", time: "2 ч", task: "GET запрос к публичному API.", links: ["JSONPlaceholder||https://jsonplaceholder.typicode.com/"] },
              { day: 46, title: "async/await", time: "2 ч", task: "Переписать код на async/await.", links: [] },
              { day: 47, title: "Обработка ошибок", time: "2 ч", task: "try/catch/finally, пользовательские ошибки.", links: [] },
              { day: 48, title: "Проект: Мини SPA", time: "4-5 ч", task: "Список пользователей + детали + поиск.", links: [] },
              { day: 49, title: "Улучшение SPA", time: "4-5 ч", task: "Лоадер, сортировка, обработка ошибок.", links: [] }
            ]
          },
          {
            week: 8, title: "Неделя 8 — Node.js и сборка", days: [
              { day: 50, title: "Node.js основы", time: "2 ч", task: "Запуск скрипта, process.env.", links: [] },
              { day: 51, title: "CommonJS модули", time: "2 ч", task: "module.exports / require.", links: [] },
              { day: 52, title: "npm пакеты", time: "2 ч", task: "Установка lodash, импорт и использование.", links: [] },
              { day: 53, title: "ES модули", time: "2 ч", task: "import/export и Babel.", links: [] },
              { day: 54, title: "Webpack & Babel", time: "2 ч", task: "entry/output/loader/plugin.", links: [] },
              { day: 55, title: "Проект: SPA + сборка", time: "4-5 ч", task: "Перенос SPA в структуру с билдом.", links: [] },
              { day: 56, title: "ESLint/Prettier", time: "4-5 ч", task: "Настройка правил, фиксы.", links: [] }
            ]
          }
        ]
      },
      // Месяц 3
      {
        month: 3, title: "Месяц 3. React и современный фронтенд", weeks: [
          {
            week: 9, title: "Неделя 9 — Основы React", days: [
              { day: 57, title: "Quick Start", time: "2 ч", task: "Создание проекта (Vite) + первый компонент.", links: ["React Quick Start||https://react.dev/learn"] },
              { day: 58, title: "JSX", time: "2 ч", task: "Разметка в JS, выражения в JSX.", links: [] },
              { day: 59, title: "useState", time: "2 ч", task: "Счетчик, несколько состояний.", links: [] },
              { day: 60, title: "Рендер списков", time: "2 ч", task: "key и производительность.", links: [] },
              { day: 61, title: "Условный рендер", time: "2 ч", task: "Тернарные операторы, &&.", links: [] },
              { day: 62, title: "Проект: To-Do React", time: "4-5 ч", task: "Перенос To-Do на компоненты.", links: [] },
              { day: 63, title: "Стилизация", time: "4-5 ч", task: "CSS Modules / styled-components.", links: [] }
            ]
          },
          {
            week: 10, title: "Неделя 10 — Данные и маршруты", days: [
              { day: 64, title: "useEffect", time: "2 ч", task: "Загрузка данных при монтировании.", links: [] },
              { day: 65, title: "React Router", time: "2 ч", task: "Маршруты и Link.", links: [] },
              { day: 66, title: "Формы", time: "2 ч", task: "Контролируемые компоненты.", links: [] },
              { day: 67, title: "Context API", time: "2 ч", task: "Глобальные данные без проп-дрилинга.", links: [] },
              { day: 68, title: "useReducer", time: "2 ч", task: "Рефактор состояния To-Do.", links: [] },
              { day: 69, title: "Проект: Заметки", time: "4-5 ч", task: "Приложение заметок с роутингом.", links: [] },
              { day: 70, title: "Оптимизация заметок", time: "4-5 ч", task: "Поиск/сортировка/локальное хранение.", links: [] }
            ]
          },
          {
            week: 11, title: "Неделя 11 — Продвинутый React", days: [
              { day: 71, title: "Кастомные хуки", time: "2 ч", task: "Вынос повторной логики.", links: [] },
              { day: 72, title: "Порталы", time: "2 ч", task: "Модальное окно вне DOM-иерархии.", links: [] },
              { day: 73, title: "Оптимизация", time: "2 ч", task: "useMemo/useCallback/React.memo.", links: [] },
              { day: 74, title: "Анимации", time: "2 ч", task: "Framer Motion базовые переходы.", links: [] },
              { day: 75, title: "Error Boundaries", time: "2 ч", task: "Компонент ловли ошибок.", links: [] },
              { day: 76, title: "Проект: Улучшение заметок", time: "4-5 ч", task: "Модалки + анимации + обработка ошибок.", links: [] },
              { day: 77, title: "Тесты компонентов", time: "4-5 ч", task: "React Testing Library первые тесты.", links: [] }
            ]
          },
          {
            week: 12, title: "Неделя 12 — CSS фреймворки", days: [
              { day: 78, title: "Bootstrap", time: "2 ч", task: "Сетка/карточки/кнопки.", links: ["Bootstrap||https://getbootstrap.com/"] },
              { day: 79, title: "Tailwind ввод", time: "2 ч", task: "Утилитарные классы и конфигурация.", links: ["Tailwind||https://tailwindcss.com/"] },
              { day: 80, title: "Адаптивность Tailwind", time: "2 ч", task: "breakpoints и состояния.", links: [] },
              { day: 81, title: "Кастомизация Tailwind", time: "2 ч", task: "Настройка theme.", links: [] },
              { day: 82, title: "Сравнение подходов", time: "2 ч", task: "Переписать секцию: Bootstrap vs Tailwind.", links: [] },
              { day: 83, title: "Проект: Магазин (ч1)", time: "4-5 ч", task: "Карточки товаров + сетка.", links: [] },
              { day: 84, title: "Магазин улучшения", time: "4-5 ч", task: "Фильтры, корзина UI.", links: [] }
            ]
          }
        ]
      },
      // Месяц 4
      {
        month: 4, title: "Месяц 4. TypeScript, GraphQL, Next.js, Auth", weeks: [
          {
            week: 13, title: "Неделя 13 — TypeScript", days: [
              { day: 85, title: "Введение TS", time: "2 ч", task: "tsc init, компиляция hello.ts.", links: ["TypeScript||https://www.typescriptlang.org/"] },
              { day: 86, title: "Базовые типы", time: "2 ч", task: "string/number/boolean/array/tuple.", links: [] },
              { day: 87, title: "Интерфейсы", time: "2 ч", task: "interface vs type, расширение.", links: [] },
              { day: 88, title: "Generics", time: "2 ч", task: "Generic функции и интерфейсы.", links: [] },
              { day: 89, title: "TS + React", time: "2 ч", task: "Типизация Props/State.", links: [] },
              { day: 90, title: "Рефакторинг проектов", time: "4-5 ч", task: "Перенос To-Do на TS (strict).", links: [] },
              { day: 91, title: "Продвинутые типы", time: "4-5 ч", task: "Union/Intersection/utility types.", links: [] }
            ]
          },
          {
            week: 14, title: "Неделя 14 — GraphQL", days: [
              { day: 92, title: "Что такое GraphQL", time: "2 ч", task: "Запросы vs REST.", links: ["GraphQL Intro||https://graphql.org/learn/"] },
              { day: 93, title: "Схема и типы", time: "2 ч", task: "type Query/Mutation.", links: [] },
              { day: 94, title: "Запросы/мутации", time: "2 ч", task: "playground, variables.", links: [] },
              { day: 95, title: "Эволюция API", time: "2 ч", task: "Добавление поля + @deprecated.", links: [] },
              { day: 96, title: "GraphQL в React", time: "2 ч", task: "Apollo Client setup.", links: [] },
              { day: 97, title: "Проект: API + клиент", time: "4-5 ч", task: "Список книг (CRUD).", links: [] },
              { day: 98, title: "Улучшения проекта", time: "4-5 ч", task: "Пагинация/загрузка/ошибки.", links: [] }
            ]
          },
          {
            week: 15, title: "Неделя 15 — Next.js", days: [
              { day: 99, title: "Введение Next.js", time: "2 ч", task: "Структура, pages.", links: ["Next.js||https://nextjs.org/docs"] },
              { day: 100, title: "Маршрутизация", time: "2 ч", task: "Навигация + layout.", links: [] },
              { day: 101, title: "SSR и SSG", time: "2 ч", task: "getServerSideProps/getStaticProps.", links: [] },
              { day: 102, title: "Динамические маршруты", time: "2 ч", task: "[id] и getStaticPaths.", links: [] },
              { day: 103, title: "Image и стили", time: "2 ч", task: "next/image + CSS Modules.", links: [] },
              { day: 104, title: "Проект: Блог (ч1)", time: "4-5 ч", task: "Markdown статьи + динамические страницы.", links: [] },
              { day: 105, title: "Блог улучшения", time: "4-5 ч", task: "SEO + деплой Vercel.", links: [] }
            ]
          },
          {
            week: 16, title: "Неделя 16 — Аутентификация и безопасность", days: [
              { day: 106, title: "Основы Auth", time: "2 ч", task: "JWT vs Cookies vs OAuth.", links: [] },
              { day: 107, title: "NextAuth", time: "2 ч", task: "Провайдер GitHub вход.", links: [] },
              { day: 108, title: "XSS/CSRF", time: "2 ч", task: "Примеры атак и защита.", links: [] },
              { day: 109, title: "Защита маршрутов", time: "2 ч", task: "Middleware auth.", links: [] },
              { day: 110, title: "UI библиотеки", time: "2 ч", task: "Material UI настройка темы.", links: [] },
              { day: 111, title: "CMS интеграция", time: "4-5 ч", task: "Headless CMS контент.", links: [] },
              { day: 112, title: "Аудит безопасности", time: "4-5 ч", task: "Проверка заголовков, CSP.", links: [] }
            ]
          }
        ]
      },
      // Месяц 5
      {
        month: 5, title: "Месяц 5. Тестирование и качество", weeks: [
          {
            week: 17, title: "Неделя 17 — Юнит-тесты", days: [
              { day: 113, title: "Jest ввод", time: "2 ч", task: "Установка + первый тест.", links: ["Jest||https://jestjs.io/"] },
              { day: 114, title: "Matchers", time: "2 ч", task: "toBe/toEqual/toContain.", links: [] },
              { day: 115, title: "Mocks & Timers", time: "2 ч", task: "jest.fn()/fake timers.", links: [] },
              { day: 116, title: "Snapshot", time: "2 ч", task: "Снапшот компонента.", links: [] },
              { day: 117, title: "RTL", time: "2 ч", task: "Render + screen.getBy*.", links: [] },
              { day: 118, title: "Проект: Тесты заметок", time: "4-5 ч", task: "CRUD тесты.", links: [] },
              { day: 119, title: "Coverage", time: "4-5 ч", task: "Отчет покрытия + улучшения.", links: [] }
            ]
          },
          {
            week: 18, title: "Неделя 18 — Cypress (E2E)", days: [
              { day: 120, title: "Cypress ввод", time: "2 ч", task: "init и первый spec.", links: [] },
              { day: 121, title: "Поиск элементов", time: "2 ч", task: "cy.get/contains.", links: [] },
              { day: 122, title: "Взаимодействия", time: "2 ч", task: "click/type/check.", links: [] },
              { day: 123, title: "Сеть и intercept", time: "2 ч", task: "Мокирование ответа.", links: [] },
              { day: 124, title: "Стратегии", time: "2 ч", task: "Организация тестов.", links: [] },
              { day: 125, title: "Проект: E2E блог", time: "4-5 ч", task: "Навигация + форма создания.", links: [] },
              { day: 126, title: "CI для Cypress", time: "4-5 ч", task: "GitHub Actions workflow.", links: [] }
            ]
          },
          {
            week: 19, title: "Неделя 19 — Производительность и a11y", days: [
              { day: 127, title: "Метрики", time: "2 ч", task: "FCP/LCP/CLS измерение Lighthouse.", links: [] },
              { day: 128, title: "Оптимизация загрузки", time: "2 ч", task: "Code splitting, lazy.", links: [] },
              { day: 129, title: "Accessibility основы", time: "2 ч", task: "ARIA, контраст.", links: [] },
              { day: 130, title: "Практика a11y", time: "2 ч", task: "Фокус, alt, aria-label.", links: [] },
              { day: 131, title: "PWA основы", time: "2 ч", task: "Service Worker, manifest.", links: [] },
              { day: 132, title: "Проект: PWA", time: "4-5 ч", task: "Добавить offline кеш статических ресурсов.", links: [] },
              { day: 133, title: "Оптимизация отчета", time: "4-5 ч", task: "Повторный прогон Lighthouse.", links: [] }
            ]
          },
          {
            week: 20, title: "Неделя 20 — Mobile/Desktop", days: [
              { day: 134, title: "React Native ввод", time: "2 ч", task: "Создание проекта Expo.", links: [] },
              { day: 135, title: "RN компоненты", time: "2 ч", task: "View/Text/Button/state.", links: [] },
              { day: 136, title: "RN навигация", time: "2 ч", task: "react-navigation stack.", links: [] },
              { day: 137, title: "Electron основы", time: "2 ч", task: "Первое окно, main/renderer.", links: [] },
              { day: 138, title: "API во фронте", time: "2 ч", task: "fetch/axios общие паттерны.", links: [] },
              { day: 139, title: "Проект: RN To-Do", time: "4-5 ч", task: "AsyncStorage список задач.", links: [] },
              { day: 140, title: "Проект: Electron заметки", time: "4-5 ч", task: "Файловое хранение заметок.", links: [] }
            ]
          }
        ]
      },
      // Месяц 6
      {
        month: 6, title: "Месяц 6. Визуализация, генераторы, CI/CD", weeks: [
          {
            week: 21, title: "Неделя 21 — Визуализация и анимации", days: [
              { day: 141, title: "Chart.js/D3 ввод", time: "2 ч", task: "Простой бар-чарт.", links: [] },
              { day: 142, title: "CSS анимации", time: "2 ч", task: "transition/animation keyframes.", links: [] },
              { day: 143, title: "Framer Motion", time: "2 ч", task: "AnimatePresence.", links: [] },
              { day: 144, title: "Интерактивная диаграмма", time: "2 ч", task: "Hover tooltip.", links: [] },
              { day: 145, title: "Чарт в React", time: "2 ч", task: "Компонент Chart пропсы.", links: [] },
              { day: 146, title: "Проект: Навыки визуализация", time: "4-5 ч", task: "Диаграмма навыков + анимация.", links: [] },
              { day: 147, title: "Доступность графики", time: "4-5 ч", task: "ARIA описание диаграмм.", links: [] }
            ]
          },
          {
            week: 22, title: "Неделя 22 — SSG и CMS", days: [
              { day: 148, title: "SSG концепция", time: "2 ч", task: "Gatsby/Astro обзор.", links: [] },
              { day: 149, title: "Gatsby старт", time: "2 ч", task: "Структура и запуск.", links: [] },
              { day: 150, title: "Страницы + GraphQL", time: "2 ч", task: "Markdown источники.", links: [] },
              { day: 151, title: "Плагины", time: "2 ч", task: "gatsby-plugin-image/SEO.", links: [] },
              { day: 152, title: "Headless CMS", time: "2 ч", task: "Подключение Strapi/Contentful.", links: [] },
              { day: 153, title: "Проект: Блог на Gatsby", time: "4-5 ч", task: "Сборка и оптимизация.", links: [] },
              { day: 154, title: "Деплой SSG", time: "4-5 ч", task: "Netlify/Vercel автодеплой.", links: [] }
            ]
          },
          {
            week: 23, title: "Неделя 23 — CI/CD и инфраструктура", days: [
              { day: 155, title: "CI/CD основы", time: "2 ч", task: "Пайплайн принципы.", links: [] },
              { day: 156, title: "GitHub Actions", time: "2 ч", task: "Workflow install+test+build.", links: [] },
              { day: 157, title: "Деплой шаг", time: "2 ч", task: "Автопубликация.", links: [] },
              { day: 158, title: "Docker ввод", time: "2 ч", task: "Dockerfile React/Node.", links: [] },
              { day: 159, title: "Docker Compose", time: "2 ч", task: "frontend+api локально.", links: [] },
              { day: 160, title: "Проект: Prod конфигурация", time: "4-5 ч", task: "CI+Docker+деплой.", links: [] },
              { day: 161, title: "Стресс тест", time: "4-5 ч", task: "autocannon/Lighthouse.", links: [] }
            ]
          },
          {
            week: 24, title: "Неделя 24 — Advanced & Real-time", days: [
              { day: 162, title: "Web Components", time: "2 ч", task: "Custom Elements + Shadow DOM.", links: [] },
              { day: 163, title: "i18n", time: "2 ч", task: "next-i18next настройка.", links: [] },
              { day: 164, title: "WebSockets", time: "2 ч", task: "Socket.io чат.", links: [] },
              { day: 165, title: "Микро-фронтенды", time: "2 ч", task: "Концепция и кейсы.", links: [] },
              { day: 166, title: "GraphQL Subscriptions", time: "2 ч", task: "Реал-тайм канал.", links: [] },
              { day: 167, title: "Проект: Real-time", time: "4-5 ч", task: "Чат/панель мониторинга.", links: [] },
              { day: 168, title: "Оптимизация real-time", time: "4-5 ч", task: "Производительность и деплой.", links: [] }
            ]
          }
        ]
      },
      // Месяц 7
      {
        month: 7, title: "Месяц 7. Повторение и итоговый проект (подготовка)", weeks: [
          {
            week: 25, title: "Неделя 25 — Повторение", days: [
              { day: 169, title: "Анализ прогресса", time: "2 ч", task: "Список тем для повторения.", links: [] },
              { day: 170, title: "HTML/CSS повтор", time: "2 ч", task: "Семантика + адаптивность.", links: [] },
              { day: 171, title: "JavaScript повтор", time: "2 ч", task: "Типы, функции, async.", links: [] },
              { day: 172, title: "React/Next повтор", time: "2 ч", task: "Компоненты/SSR.", links: [] },
              { day: 173, title: "Git/CI повтор", time: "2 ч", task: "Workflows.", links: [] },
              { day: 174, title: "План итогового проекта", time: "4-5 ч", task: "ТЗ, прототип.", links: [] },
              { day: 175, title: "Подготовка репозитория", time: "4-5 ч", task: "Структура, стек.", links: [] }
            ]
          },
          {
            week: 26, title: "Неделя 26 — Итоговый проект: разработка", days: [
              { day: 176, title: "Старт проекта", time: "2 ч", task: "Создание базовой структуры.", links: [] },
              { day: 177, title: "UI каркас", time: "2 ч", task: "Навигация/шапка.", links: [] },
              { day: 178, title: "Состояние", time: "2 ч", task: "Context/Redux.", links: [] },
              { day: 179, title: "Backend/API", time: "2 ч", task: "Подключение API или mock.", links: [] },
              { day: 180, title: "Ключевой функционал", time: "2 ч", task: "CRUD/поиск.", links: [] },
              { day: 181, title: "Auth & защита", time: "4-5 ч", task: "Авторизация и ошибки.", links: [] },
              { day: 182, title: "PWA функции", time: "4-5 ч", task: "Service Worker/offline.", links: [] }
            ]
          },
          {
            week: 27, title: "Неделя 27 — Тесты и оптимизация", days: [
              { day: 183, title: "Юнит-тесты", time: "2 ч", task: "Покрытие логики.", links: [] },
              { day: 184, title: "E2E тесты", time: "2 ч", task: "Основные сценарии.", links: [] },
              { day: 185, title: "Производительность", time: "2 ч", task: "Lighthouse улучшения.", links: [] },
              { day: 186, title: "Доступность", time: "2 ч", task: "axe DevTools.", links: [] },
              { day: 187, title: "SEO оптимизация", time: "2 ч", task: "Metadata/OpenGraph.", links: [] },
              { day: 188, title: "UI/UX polishing", time: "4-5 ч", task: "Правки интерфейса.", links: [] },
              { day: 189, title: "Release подготовка", time: "4-5 ч", task: "CI/CD финальный.", links: [] }
            ]
          }
        ]
      },
      // Месяц 8
      {
        month: 8, title: "Месяц 8. Презентация и финал", weeks: [
          {
            week: 28, title: "Неделя 28 — Завершение", days: [
              { day: 190, title: "README", time: "2 ч", task: "Описание проекта.", links: [] },
              { day: 191, title: "Презентация", time: "2 ч", task: "Слайды/демо.", links: [] },
              { day: 192, title: "Самоанализ", time: "2 ч", task: "Что улучшить дальше.", links: [] },
              { day: 193, title: "Обновление профилей", time: "2 ч", task: "GitHub/LinkedIn.", links: [] },
              { day: 194, title: "План развития", time: "2 ч", task: "Следующие технологии.", links: [] },
              { day: 195, title: "Open Source/Хакатоны", time: "4-5 ч", task: "Выбор репозитория.", links: [] },
              { day: 196, title: "Финиш!", time: "4-5 ч", task: "Подведение итогов и отдых.", links: [] }
            ]
          }
        ]
      }
    ];

    // --- Мета: цели месяцев (goal) ---
    const monthMeta = {
      1: { goal: 'Сформировать фундамент: понять устройство интернета, освоить базовый и продвинутый HTML/CSS и рабочие инструменты.' },
      2: { goal: 'Освоить основы JavaScript, работу с DOM, асинхронность и базовую сборку.' },
      3: { goal: 'Погрузиться в React и современные подходы к стилизации и архитектуре.' },
      4: { goal: 'Добавить типизацию (TypeScript), GraphQL, Next.js и понять основы безопасности.' },
      5: { goal: 'Внедрить культуру качества: тестирование (юнит/E2E), производительность и доступность.' },
      6: { goal: 'Научиться визуализации, статической генерации, CI/CD и продвинутым паттернам.' },
      7: { goal: 'Систематизировать знания и реализовать итоговый проект.' },
      8: { goal: 'Финализация, презентация результата и планирование дальнейшего развития.' }
    };

    // --- Генерация задач (списков) на лету ---
    function buildMonthTasks(month){
      return month.weeks.map(w => w.title.replace(/^[^—]*—\s*/,'').trim());
    }
    function buildWeekTasks(week){
      return week.days.map(d => `День ${d.day}: ${d.title}`);
    }
    function buildDayTasks(day){
      // Разбиваем описание на подзадачи по запятым/точкам/точкам с запятой
      const raw = (day.task||'').split(/[\.;,]/).map(s=>s.trim()).filter(s=>s.length>3);
      // Если в результате пусто – используем целиком task как одну задачу
      return raw.length ? raw : (day.task? [day.task] : []);
    }
    function buildDayGoal(day){
      // Проектные дни отмечаем явно
      if(/Проект/i.test(day.title)) return 'Применить и закрепить навыки: ' + day.title.replace(/Проект:?\s*/i,'').trim();
      return 'Освоить тему: ' + day.title;
    }

    // --- Подробные описания недель ---
    const weekDescriptions = {
      1: "Фундаментальные основы работы интернета, протокола HTTP, доменных имён и базовая публикация. Цель — понимать цепочку: пользователь → DNS → запрос → ответ браузера.",
      2: "Семантическая HTML-разметка и базовая стилизация. Формирование устойчивого навыка аккуратной структуры документа и адаптивности.",
      3: "Углубление в современный CSS: сетки, препроцессор, архитектура и поддерживаемость стилей.",
      4: "Инструменты разработчика: Git workflow, npm экосистема, стандарты форматирования и качество кода.",
      5: "Вход в JavaScript — синтаксис, базовые структуры данных, управление потоком и простые приложения.",
      6: "Практическая работа с DOM, событиями и структурой данных в браузере.",
      7: "Асинхронное программирование: таймеры, промисы, загрузка данных, обработка ошибок.",
      8: "Node.js как среда выполнения + основы модульности и сборки фронтенда.",
      9: "React: мышление в компонентах, состояние и рендеринг списков.",
      10: "Побочные эффекты, маршрутизация, формы, глобальное состояние и архитектура данных.",
      11: "Оптимизация, повторное использование логики, улучшение UX (анимации) и надежность (обработка ошибок, тесты).",
      12: "Индустриальные подходы к стилизации: UI-фреймворки, утилитарные классы и сравнение методологий.",
      13: "TypeScript — введение в типизацию, повышение надежности и рефакторинг мини-проектов.",
      14: "GraphQL: построение схем, запросы и интеграция на клиенте.",
      15: "Next.js: рендеринг на сервере, генерация статических страниц и оптимизация ресурсов.",
      16: "Аутентификация, безопасность и интеграция UI-библиотек + CMS.",
      17: "Юнит-тестирование: изоляция логики, покрытие и устойчивость к регрессиям.",
      18: "Системное E2E тестирование пользовательских сценариев и интеграция в CI.",
      19: "Производительность, доступность (a11y) и прогрессивные веб-приложения.",
      20: "Кросс-платформенность: мобильные (React Native) и десктопные (Electron) клиенты.",
      21: "Анимации и визуализация данных: повышение информативности и интерактивности интерфейсов.",
      22: "Статическая генерация (SSG), контент через Headless CMS и оптимизация цепочки поставки контента.",
      23: "CI/CD, контейнеризация и инфраструктурные практики для надежного диплоя.",
      24: "Расширенные фронтенд-паттерны: real-time, микро-фронтенды, интернационализация.",
      25: "Ревизия знаний и подготовка архитектуры итогового проекта.",
      26: "Активная разработка ключевого функционала итогового продукта.",
      27: "Тестовое покрытие, полировка производительности, SEO и UX.",
      28: "Финализация, документация, презентация и дальнейшая стратегическая траектория развития."
    };

    // --- Дополнительные ссылки по ключевым словам (рессурсы добавляются, если в дне мало ссылок) ---
    const keywordLinkGroups = [
      { match: /internet|браузер|dns/i, links: ["MDN - Как работает браузер||https://developer.mozilla.org/ru/docs/Web/Performance/How_browsers_work", "MDN - DNS||https://developer.mozilla.org/ru/docs/Glossary/DNS"] },
      { match: /http|fetch/i, links: ["MDN - HTTP заголовки||https://developer.mozilla.org/ru/docs/Web/HTTP/Headers", "HTTP Status Codes||https://http.cat/"] },
      { match: /html|семантик/i, links: ["HTML Living Standard||https://html.spec.whatwg.org/", "A11y семантика||https://web.dev/learn/accessibility/semantics"] },
      { match: /css|flex|grid|адаптив/i, links: ["MDN - Flexbox||https://developer.mozilla.org/ru/docs/Web/CSS/CSS_flexible_box_layout/Basic_concepts_of_flexbox", "MDN - Grid||https://developer.mozilla.org/ru/docs/Web/CSS/CSS_grid_layout"] },
      { match: /sass|scss/i, links: ["Sass Docs||https://sass-lang.com/documentation", "7-1 Pattern||https://sass-guidelin.es/#the-7-1-pattern"] },
      { match: /git|branch|pull/i, links: ["Pro Git||https://git-scm.com/book/ru/v2", "Git Flight Rules||https://github.com/k88hudson/git-flight-rules"] },
      { match: /node|npm|webpack|babel/i, links: ["Node.js Docs||https://nodejs.org/api/", "Webpack Concepts||https://webpack.js.org/concepts/"] },
      { match: /javascript|переменн|функц|массив|объект|json/i, links: ["JavaScript Info||https://javascript.info/", "MDN JS Reference||https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference"] },
      { match: /async|promise|таймер|fetch|await/i, links: ["MDN - Promises||https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Promise", "Async/Await Guide||https://javascript.info/async-await"] },
      { match: /react|jsx|hook|context|state|router/i, links: ["React Docs||https://react.dev/", "React Patterns||https://reactpatterns.com/"] },
      { match: /typescript|ts/i, links: ["TS Handbook||https://www.typescriptlang.org/docs/handbook/intro.html", "typescript-eslint||https://typescript-eslint.io/"] },
      { match: /graphql/i, links: ["Apollo Client||https://www.apollographql.com/docs/react/", "GraphQL Best Practices||https://graphql.org/learn/best-practices/"] },
      { match: /next\.?js|ssg|ssr/i, links: ["Next.js Routing||https://nextjs.org/docs/app/building-your-application/routing", "Next.js Data Fetching||https://nextjs.org/docs/app/building-your-application/data-fetching"] },
      { match: /auth|jwt|security|безопас/i, links: ["OWASP Top 10||https://owasp.org/www-project-top-ten/", "Cheat Sheet TLS||https://cheatsheetseries.owasp.org/"] },
      { match: /test|jest|cypress|rtl|юнит/i, links: ["Testing Library||https://testing-library.com/docs/", "Cypress Docs||https://docs.cypress.io/"] },
      { match: /performance|lighthouse|оптимизац|pwa/i, links: ["web.dev Performance||https://web.dev/fast/", "Lighthouse||https://developer.chrome.com/docs/lighthouse"] },
      { match: /accessibility|a11y|доступ/i, links: ["WCAG Overview||https://www.w3.org/WAI/standards-guidelines/wcag/", "WebAIM Checklist||https://webaim.org/standards/wcag/checklist"] },
      { match: /pwa|service worker/i, links: ["MDN - Service Worker||https://developer.mozilla.org/ru/docs/Web/API/Service_Worker_API", "Manifest Guide||https://web.dev/add-manifest/"] },
      { match: /docker|ci|cd|github actions/i, links: ["GitHub Actions Docs||https://docs.github.com/actions", "Docker Docs||https://docs.docker.com/"] },
      { match: /international|i18n|локализац/i, links: ["i18next||https://www.i18next.com/", "Unicode Guide||https://home.unicode.org/"] },
      { match: /websocket|real-time|socket/i, links: ["Socket.io Docs||https://socket.io/docs/v4", "MDN - WebSockets||https://developer.mozilla.org/ru/docs/Web/API/WebSockets_API"] },
      { match: /micro|микро-фронтенд/i, links: ["Module Federation||https://webpack.js.org/concepts/module-federation/", "Micro-frontend Patterns||https://micro-frontends.org/"] },
      { match: /visual|chart|d3|диаграм/i, links: ["Chart.js||https://www.chartjs.org/docs/latest/", "D3.js Guide||https://observablehq.com/@d3/learn-d3"] },
      { match: /electron/i, links: ["Electron Docs||https://www.electronjs.org/docs", "Electron Security||https://www.electronjs.org/docs/latest/tutorial/security"] },
      { match: /react native|expo|native/i, links: ["React Native Docs||https://reactnative.dev/", "Expo Docs||https://docs.expo.dev/"] },
      { match: /seo/i, links: ["Google SEO Starter||https://developers.google.com/search/docs/fundamentals/seo-starter-guide", "Open Graph||https://ogp.me/"] },
      { match: /readme|презентац|linkedin|резюме/i, links: ["Awesome README||https://github.com/matiassingers/awesome-readme", "LinkedIn Profile Tips||https://www.linkedin.com/help/linkedin/answer/a507663"] }
    ];

    // удалено дублирующее объявление state, теперь оно только в начале скрипта
    let currentFilter = 'all';

  // --- Состояние развёрнутых "Материалы" по дням ---
  let extraOpen = {};
  try { extraOpen = JSON.parse(localStorage.getItem('frontendExtraOpen')||'{}')||{}; } catch(e){ extraOpen = {}; }
  function saveExtraOpen(){ localStorage.setItem('frontendExtraOpen', JSON.stringify(extraOpen)); }
  function toggleExtra(day){
    extraOpen[day] = !extraOpen[day];
    saveExtraOpen();
    const wrap = document.getElementById('extra'+day);
    const btn = document.getElementById('mtgl'+day);
    if(wrap && btn){
      if(extraOpen[day]){ wrap.classList.remove('collapsed'); void wrap.offsetWidth; wrap.classList.add('fade-in'); btn.classList.add('open'); }
      else { wrap.classList.add('collapsed'); wrap.classList.remove('fade-in'); btn.classList.remove('open'); }
      updateMaterialBadge(day);
    }
  }

    // --- Пользовательские заметки и вложения ---
  let notesState = {};
  let attachmentsState = {}; // { day: { links: [{title,url}], files:[{name,data,size}] } }
  let subtasksState = {}; // { day: [{text, done}] }
  // Состояние внутренних секций (subtasks/notes/attachments)
  let sectionOpen = {}; // { day: { subtasks:true, notes:true, attachments:true } }
    try { notesState = JSON.parse(localStorage.getItem('frontendNotes')||'{}')||{}; } catch(e){ notesState = {}; }
  try { attachmentsState = JSON.parse(localStorage.getItem('frontendAttachments')||'{}')||{}; } catch(e){ attachmentsState = {}; }
  try { subtasksState = JSON.parse(localStorage.getItem('frontendSubtasks')||'{}')||{}; } catch(e){ subtasksState = {}; }
  try { sectionOpen = JSON.parse(localStorage.getItem('frontendSectionOpen')||'{}')||{}; } catch(e){ sectionOpen = {}; }

  function saveSectionOpen(){ localStorage.setItem('frontendSectionOpen', JSON.stringify(sectionOpen)); }
  function ensureSectionDefaults(day){
    if(!sectionOpen[day]){ sectionOpen[day] = { subtasks:true, notes:true, attachments:true }; }
  }
  function toggleSection(day, sec){
    ensureSectionDefaults(day);
    sectionOpen[day][sec] = !sectionOpen[day][sec];
    saveSectionOpen();
    applySectionState(day, sec);
  }
  function applySectionState(day, sec){
    const btn = document.getElementById(sec+'Toggle'+day);
    const body = document.getElementById(sec+'Body'+day);
    if(!btn || !body) return;
    const open = sectionOpen[day]?.[sec];
    if(open){ btn.classList.add('open'); body.classList.remove('collapsed'); }
    else { btn.classList.remove('open'); body.classList.add('collapsed'); }
  }

    function saveNotes(){ localStorage.setItem('frontendNotes', JSON.stringify(notesState)); scheduleCloudUpload(); }
  function saveAttachments(){ localStorage.setItem('frontendAttachments', JSON.stringify(attachmentsState)); scheduleCloudUpload(); }
  function saveSubtasks(){ localStorage.setItem('frontendSubtasks', JSON.stringify(subtasksState)); scheduleCloudUpload(); }
    // Миграция: если значение было строкой — оборачиваем в массив заметок
    function migrateNotes(){
      Object.keys(notesState).forEach(k => {
        if(typeof notesState[k] === 'string'){
          const trimmed = notesState[k].trim();
          notesState[k] = trimmed ? [{ text: trimmed, ts: Date.now() }] : [];
        }
      });
      saveNotes();
    }
    migrateNotes();
    function addNote(day, text){
      const val = (text||'').trim(); if(!val) return;
      if(!Array.isArray(notesState[day])) notesState[day] = [];
      notesState[day].push({ text: escapeHTML(val), ts: Date.now() });
      saveNotes();
      renderNotes(day);
      updateMaterialBadge(day);
    }
    function deleteNote(day, idx){ if(!Array.isArray(notesState[day])) return; notesState[day].splice(idx,1); saveNotes(); renderNotes(day); updateMaterialBadge(day); }
    function renderNotes(day){
      const listEl = document.getElementById('notesList'+day); if(!listEl) return;
      const arr = Array.isArray(notesState[day]) ? notesState[day] : [];
      if(!arr.length){ listEl.innerHTML = '<li style="opacity:.5;font-size:11px;">(нет заметок)</li>'; return; }
      listEl.innerHTML = arr.map((n,i)=>`<li><span class="inline-badge">NOTE</span><span class="note-text">${n.text}</span><button class="x-btn" title="Удалить" onclick="deleteNote(${day},${i})">✕</button></li>`).join('');
    }
    function updateCloudUI(){
      const indicator=document.getElementById('cloudStatus');
      const dot=document.getElementById('cloudDot');
      const hint=document.getElementById('cloudHint');
      const ls=document.getElementById('cloudLastSync');
      const gBtn=document.getElementById('cloudGoogleBtn');
      if(!indicator||!dot||!hint) return;
      const lastSyncTs=localStorage.getItem('cloudLastSync');
      const lastSync= lastSyncTs? new Date(parseInt(lastSyncTs)):null;
      const remoteMs = remoteSnapshotMeta?.updatedAt ? remoteSnapshotMeta.updatedAt.getTime() : 0;
      const localMs = lastSync ? lastSync.getTime() : 0;
      indicator.classList.remove('synced','warn','off','pending');
      dot.className='cloud-dot';
      const sizeStr = currentSnapshotSizeKB();
      if(!cloudUser){
        indicator.classList.add('off');
        dot.classList.add('state-off');
        hint.textContent='OFF';
        if(ls) ls.textContent='';
        if(gBtn){ gBtn.className='cloud-g-btn full'; gBtn.innerHTML='<span class="g-ic">'+googleSVGIcon()+'</span><span>Войти</span>'; gBtn.title='Войти через Google'; gBtn.onclick=cloudGoogleSignIn; }
      } else if(cloudUser.isAnonymous){
        indicator.classList.add('warn');
        dot.classList.add('state-warn');
        hint.textContent='ANON';
        if(ls) ls.textContent= lastSync? ('синк '+fmtDate(lastSync)+' · '+sizeStr+'KB') : '';
        if(gBtn){ gBtn.className='cloud-g-btn full'; gBtn.innerHTML='<span class="g-ic">'+googleSVGIcon()+'</span><span>Связать</span>'; gBtn.title='Связать с Google'; gBtn.onclick=cloudGoogleSignIn; }
      } else {
        if(cloudSyncPending){
          indicator.classList.add('pending'); dot.classList.add('state-pending','pulse'); hint.textContent='PEND';
        } else if(remoteMs > localMs + 2500){
          indicator.classList.add('warn'); dot.classList.add('state-warn'); hint.textContent='STALE';
        } else {
          indicator.classList.add('synced'); dot.classList.add('state-ok'); hint.textContent='OK';
        }
        if(ls) ls.textContent= lastSync? ('синк '+fmtDate(lastSync)+' · '+sizeStr+'KB') : '';
        if(gBtn){ gBtn.className='cloud-g-btn signout full'; gBtn.innerHTML='<span class="g-ic">'+googleSVGIcon()+'</span><span>Выйти</span>'; gBtn.title='Выйти из Google'; gBtn.onclick=cloudSignOut; }
      }
      const map={OFF:'Не подключено', ANON:'Аноним (не синхр. между устройствами)', PEND:'Сохранение…', STALE:'В облаке свежее (обновить/слиять)', OK:'Все синхронизировано'};
      indicator.title='Облако: '+(map[hint.textContent]||hint.textContent);
    }
    function currentSnapshotSizeKB(){ try { return (JSON.stringify(snapshotLocal()).length/1024).toFixed(1); } catch(_){ return '?'; } }
    function googleSVGIcon(){ return '\n<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <path fill="#EA4335" d="M12 10.8v3.84h5.42c-.24 1.26-.98 2.33-2.08 3.05l3.36 2.61c1.96-1.81 3.09-4.47 3.09-7.66 0-.74-.07-1.45-.2-2.14H12z"/>\n  <path fill="#34A853" d="M6.56 14.32 5.8 14.9l-2.68 2.06C5.08 20.6 8.29 22.5 12 22.5c2.7 0 4.96-.9 6.61-2.45l-3.36-2.61c-.9.6-2.05.96-3.25.96-2.51 0-4.65-1.69-5.44-3.97z"/>\n  <path fill="#4A90E2" d="M5.8 9.1 3.12 7.04C2.41 8.37 2 9.9 2 11.5s.41 3.13 1.12 4.46l3.44-2.66c-.2-.6-.31-1.25-.31-1.9 0-.66.11-1.3.31-1.9z"/>\n  <path fill="#FBBC05" d="M12 6.5c1.47 0 2.78.51 3.81 1.5l2.85-2.85C16.95 3.76 14.7 2.9 12 2.9 8.29 2.9 5.08 4.8 3.12 7.04L5.8 9.1c.79-2.28 2.93-3.97 5.44-3.97z"/>\n</svg>'; }
    function bytesToKB(b){ return (b/1024).toFixed(1)+' KB'; }
    function escapeHTML(str){ return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]||c)); }
    // Форматирование даты для облачного индикатора: если сегодня -> HH:MM, иначе -> DD.MM HH:MM
    function fmtDate(d){
      try {
        if(!d) return '';
        if(!(d instanceof Date)) d = new Date(d);
        const pad = n => (n<10?'0':'')+n;
        const now = new Date();
        const sameDay = d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
        const time = pad(d.getHours())+':'+pad(d.getMinutes());
        if(sameDay) return time;
        return pad(d.getDate())+'.'+pad(d.getMonth()+1)+' '+time; // без года чтобы короче
      } catch(_){ return ''; }
    }
    function renderUserLinks(day){
      const ul = document.querySelector(`#userLinks${day}`); if(!ul) return;
      const list = (attachmentsState[day]?.links)||[];
  ul.innerHTML = list.map((l,i)=>`<li><span class="inline-badge">LINK</span><a href="${l.url}" target="_blank">${l.title}</a><button class="x-btn" onclick="deleteLink(${day},${i})" title="Удалить">✕</button></li>`).join('');
    }
    // --- Подзадачи дней ---
    function generateTemplateSubtasks(dayObj){
      const title = (dayObj.title||'').toLowerCase();
      const task = (dayObj.task||'').toLowerCase();
      const rawPieces = (dayObj.task||'')
        .split(/[.;]+/)
        .map(s=>s.trim())
        .filter(s=>s.length>4);
      const subtasks = [];
      const push = t => { if(t && !subtasks.includes(t)) subtasks.push(t); };

      // Общие базовые шаги
      push('Прочитать теорию/документацию по теме');
      push('Сделать краткий конспект (5–7 пунктов)');

      // Категории
      if(/internet|dns|браузер|http/.test(task+title)){
        push('Нарисовать схему: клиент → DNS → сервер → ответ');
        push('Открыть DevTools → Network и проанализировать 3 запроса');
      }
      if(/git|ветк|branch|pull|merge/.test(task+title)){
        push('Создать тестовую ветку и выполнить merge через PR');
        push('Разрешить (симулировать) конфликт слияния');
      }
      if(/форм|form/.test(task+title)){
        push('Сверстать форму с валидацией HTML-атрибутами');
        push('Проверить фокус и доступность (Tab-навигация)');
      }
      if(/flex|grid/.test(task+title)){
        push('Перестроить макет под мобильный (<600px)');
        push('Проверить выравнивание элементов в разных браузерах');
      }
      if(/sass|scss/.test(task+title)){
        push('Вынести цвета и размеры в переменные');
        push('Разбить стили на partials и импортировать их');
      }
      if(/javascript|переменн|функц|массив|объект|json/.test(task+title)){
        push('Написать минимум 3 мини-примера в консоли');
        push('Объяснить вслух что делает каждый пример');
      }
      if(/promise|async|await|fetch/.test(task+title)){
        push('Сделать запрос fetch и обработать ошибки');
        push('Переписать пример на async/await');
      }
      if(/react|jsx|hook|context|state/.test(task+title)){
        push('Создать маленький компонент (50-70 строк) для практики');
        push('Добавить минимум 1 проверку состояния/условный рендер');
      }
      if(/typescript|ts/.test(task+title)){
        push('Заменить any на конкретный тип');
        push('Добавить интерфейс или type для структуры данных');
      }
      if(/test|jest|cypress|rtl/.test(task+title)){
        push('Написать 1 позитивный и 1 негативный тест');
        push('Посмотреть падающий тест и починить причину');
      }
      if(/performance|оптимизац|lighthouse|pwa/.test(task+title)){
        push('Сделать замер Lighthouse до изменений');
        push('Применить оптимизацию и сравнить метрики');
      }
      if(/git hub actions|ci|cd|docker/.test(task+title)){
        push('Настроить простой workflow build+test');
        push('Добавить бейдж статуса в README');
      }
      if(/проект|spa|блог|магазин|реал-?time|чат|final|итог/i.test(task+title)){
        push('Сформулировать 3 ближайших шага по проекту');
        push('Сделать коммит с осмысленным сообщением');
      }

      // Из исходного task вытаскиваем глаголы и формируем задания «Сделать ...»
      rawPieces.forEach(p=>{
        const low = p.toLowerCase();
        if(/проанализир|разбор|посмотреть/.test(low)) push('Проанализировать пример из документации');
        if(/созда|сдела|реализ|оптимиз|добав|перенес|перепис/.test(low)) push('Реализовать мини-версию на практике');
      });

      // Финальные обязательные шаги
      push('Подвести итоги: 2-3 вывода в заметках');

      return subtasks.slice(0,8);
    }
    function ensureSubtasks(dayObj){
      const generated = generateTemplateSubtasks(dayObj);
      if(!subtasksState[dayObj.day]){
        subtasksState[dayObj.day] = generated.map(t=>({text:t, done:false, system:true}));
        if(generated.length) saveSubtasks();
        return;
      }
      let changed = false;
      // Миграция: добавить system где отсутствует
      subtasksState[dayObj.day] = subtasksState[dayObj.day].map(item => {
        if(item.system === undefined){
          const isSystem = generated.some(g => g === item.text);
            if(isSystem){ item.system = true; changed = true; }
            else { item.system = false; changed = true; }
        }
        return item;
      });
      // Добавить отсутствующие системные
      generated.forEach(t => {
        if(!subtasksState[dayObj.day].some(it => it.text === t)){
          subtasksState[dayObj.day].push({ text: t, done:false, system:true });
          changed = true;
        }
      });
      if(changed) saveSubtasks();
    }
    function renderSubtasks(day){
      const wrap = document.getElementById('subtasks'+day); if(!wrap) return;
      const list = subtasksState[day]||[];
  const ul = wrap.querySelector('.subtask-list'); if(!ul) return;
  ul.innerHTML = list.map((s,i)=>`<li class="subtask-item ${s.done?'done':''}"><input type="checkbox" ${s.done?'checked':''} onchange="toggleSubtask(${day},${i})"><div class="subtask-box"><span>${s.text}</span>${s.system?'<span class="sys-badge" title="Системная подзадача">SYS</span>':`<button aria-label="Удалить" title="Удалить подзадачу" onclick="deleteSubtask(${day},${i})">✕</button>`}</div></li>`).join('');
  updateSubtaskProgress(day);
    }
    function toggleSubtask(day, idx){ const arr = subtasksState[day]; if(!arr) return; arr[idx].done = !arr[idx].done; saveSubtasks(); renderSubtasks(day); }
    function addSubtask(day){ const input = document.getElementById('newSubtask'+day); if(!input) return; const val = input.value.trim(); if(!val) return; if(!subtasksState[day]) subtasksState[day]=[]; subtasksState[day].push({text:val, done:false}); saveSubtasks(); input.value=''; renderSubtasks(day); }
  function deleteSubtask(day, idx){ if(!subtasksState[day]) return; if(subtasksState[day][idx]?.system) return; subtasksState[day].splice(idx,1); saveSubtasks(); renderSubtasks(day); }
  function updateSubtaskProgress(day){ const btn = document.getElementById('subtasksToggle'+day); const prog = document.getElementById('subtasksProg'+day); if(!btn || !prog) return; const list = subtasksState[day]||[]; const total = list.length; const done = list.filter(s=>s.done).length; prog.textContent = `${done}/${total}`; }
    // Обновление бейджей материалов на кнопке
    function updateMaterialBadge(day){
      const btn = document.getElementById('mtgl'+day); if(!btn) return;
      const linksCount = (attachmentsState[day]?.links?.length)||0;
  const filesCount = 0; // загрузка файлов отключена
      const noteActive = Array.isArray(notesState[day]) ? notesState[day].length>0 : (typeof notesState[day]==='string' && notesState[day].trim().length>0);
      const isOpen = !!extraOpen[day];
      btn.innerHTML = `<span class="arrow">▶</span>${isOpen? ' Скрыть материалы':' Материалы'}<span class="mat-badges">`
        + (linksCount? `<span class=\"mat-badge link\" title=\"Пользовательских ссылок\">🔗 ${linksCount}</span>`:'')
  // файловый бейдж удалён (экономия)
        + (noteActive? `<span class=\"mat-badge note\" title=\"Заметок\">📝 ${Array.isArray(notesState[day])? notesState[day].length:1}</span>`:'')
        + `</span>`;
    }

    // Инициализация темы
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.body.setAttribute('data-theme', savedTheme);
      } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.setAttribute('data-theme', 'dark');
      } else {
        document.body.setAttribute('data-theme', 'light');
      }
    }

    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme') || 'dark';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.classList.add('theme-switching');
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      // очистка класса после анимации
      setTimeout(()=>document.body.classList.remove('theme-switching'), 650);
    }

    // Слушаем изменения системной темы
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem('theme')) {
          document.body.setAttribute('data-theme', e.matches ? 'dark' : 'light');
        }
      });
    }

    function save(){ localStorage.setItem('frontendPlan', JSON.stringify(state)); scheduleCloudUpload(); }

    function toggle(day) {
      // Если было выполнено – удаляем ключ (чистый объект), иначе ставим true
      if(state[day]) delete state[day]; else state[day] = true;
      save();
      updateStats();
      render();
    }

    let lastPercentValue = 0;
    function updateStats() {
      const done = Object.keys(state).filter(k => state[k]).length;
      const total = 196; // фиксированное общее кол-во
      const left = total - done;
      const pct = total === 0 ? 0 : Math.round((done / total) * 100);

      // Мгновенное обновление чисел (никакой задержки визуально)
      document.getElementById('done').textContent = done;
      document.getElementById('left').textContent = left;
      document.getElementById('pct').textContent = pct + '%';

      const bar = document.getElementById('bar');
      if (bar) {
        const prev = lastPercentValue;
        // Адаптивная длительность: маленькие шаги быстрее
        bar.style.transitionDuration = Math.abs(pct - prev) < 3 ? '.30s' : '.45s';
        bar.classList.remove('pulse-boost');
        const targetWidth = pct + '%';
        const shouldPulse = pct > prev && (pct - prev) >= 1;
        requestAnimationFrame(() => {
          if (!bar.style.width) bar.style.width = prev + '%';
          requestAnimationFrame(() => {
            bar.style.width = targetWidth;
            bar.textContent = pct + '%';
            if (shouldPulse) {
              bar.classList.add('pulse-boost');
              setTimeout(() => bar.classList.remove('pulse-boost'), 900);
            }
          });
        });
        lastPercentValue = pct;
      }
    }

    // --- Состояние открытых списков ---
    let openState = { months: [], weeks: [] };
    if (localStorage.getItem('frontendOpenState')) {
      try {
        openState = JSON.parse(localStorage.getItem('frontendOpenState')) || { months: [], weeks: [] };
      } catch (e) {
        openState = { months: [], weeks: [] };
      }
    }

    function saveOpenState() {
      localStorage.setItem('frontendOpenState', JSON.stringify(openState));
    }

    // --- Состояние открытия отдельных дней ---
    let dayOpen = {};
    try { dayOpen = JSON.parse(localStorage.getItem('frontendDayOpen')||'{}')||{}; } catch(e){ dayOpen={}; }
    function saveDayOpen(){ localStorage.setItem('frontendDayOpen', JSON.stringify(dayOpen)); }
    function toggleDay(day){ dayOpen[day] = !dayOpen[day]; saveDayOpen(); const body=document.getElementById('dayBody'+day); const hdr=document.getElementById('dayHeader'+day); if(body){ body.classList.toggle('collapsed', !dayOpen[day]); } if(hdr){ hdr.classList.toggle('open', !!dayOpen[day]); } }

    function buildExtraLinks(day) {
      const base = [...(day.links || [])];
      const text = (day.title + ' ' + day.task).toLowerCase();
      keywordLinkGroups.forEach(group => {
        if (group.match.test(text)) {
          group.links.forEach(l => { if (!base.includes(l)) base.push(l); });
        }
      });
      return base;
    }

    // --- Категоризация дней для сводки ---
    function categorizeDay(day){
      const txt = (day.title + ' ' + day.task).toLowerCase();
      if(/internet|dns|http|браузер/.test(txt)) return 'Сеть';
      if(/html|семантик|форма|валид/i.test(txt)) return 'HTML';
      if(/css|flex|grid|sass|scss|tailwind|bootstrap/.test(txt)) return 'CSS';
      if(/javascript|переменн|функц|массив|объект|json|async|promise|fetch/.test(txt)) return 'JS';
      if(/react|jsx|hook|context|router|next\.js|nextjs/.test(txt)) return 'React/Next';
      if(/typescript|ts/.test(txt)) return 'TypeScript';
      if(/graphql/.test(txt)) return 'GraphQL';
      if(/test|jest|cypress|rtl/.test(txt)) return 'Тесты';
      if(/docker|ci|github actions|workflow/.test(txt)) return 'CI/CD';
      if(/performance|lighthouse|pwa|a11y|accessibility/.test(txt)) return 'Perf/A11y';
      if(/проект|spa|блог|магазин|final|итог|project/.test(txt)) return 'Проект';
      return 'Прочее';
    }

    function collectCategoryStats(){
      const stats = {};
      plan.forEach(m => m.weeks.forEach(w => w.days.forEach(d => {
        const cat = categorizeDay(d);
        if(!stats[cat]) stats[cat] = { total:0, done:0 };
        stats[cat].total++;
        if(state[d.day]) stats[cat].done++;
      })));
      return stats;
    }

    function renderCategorySummary(){
      const holder = document.getElementById('categoriesSummary');
      if(!holder) {
        console.log('categoriesSummary element not found');
        return;
      }
      const stats = collectCategoryStats();
      console.log('Category stats:', stats);
      const entries = Object.entries(stats).sort((a,b)=>a[0].localeCompare(b[0],'ru'));
      console.log('Category entries:', entries);

      // Дополнительные информационные карточки
      const totalDays = plan.reduce((sum, m) => sum + m.weeks.reduce((s, w) => s + w.days.length, 0), 0);
      const completedDays = Object.keys(state).filter(day => state[day]).length;
      const remainingDays = totalDays - completedDays;
      const progressPercent = Math.round((completedDays / totalDays) * 100);

      // Подсчет проектных дней
      const projectDays = plan.reduce((sum, m) => sum + m.weeks.reduce((s, w) => s + w.days.filter(d => /проект|spa|блог|магазин|final|итог|project/i.test(d.title + ' ' + d.task)).length, 0), 0);
      const completedProjects = Object.keys(state).filter(day => {
        const dayData = plan.find(m => m.weeks.find(w => w.days.find(d => d.day == day)))?.weeks.find(w => w.days.find(d => d.day == day))?.days.find(d => d.day == day);
        return state[day] && dayData && /проект|spa|блог|магазин|final|итог|project/i.test(dayData.title + ' ' + dayData.task);
      }).length;

      // Подсчет недель
      const totalWeeks = plan.reduce((sum, m) => sum + m.weeks.length, 0);
      const completedWeeks = plan.reduce((sum, m) => sum + m.weeks.filter(w => w.days.every(d => state[d.day])).length, 0);

      const extraCards = [
        { title: 'Общий прогресс', value: `${completedDays}/${totalDays}`, percent: progressPercent, type: 'primary' },
        { title: 'Проекты', value: `${completedProjects}/${projectDays}`, percent: Math.round((completedProjects / projectDays) * 100), type: 'success' },
        { title: 'Недели', value: `${completedWeeks}/${totalWeeks}`, percent: Math.round((completedWeeks / totalWeeks) * 100), type: 'info' },
        { title: 'Осталось дней', value: remainingDays, percent: Math.round((remainingDays / totalDays) * 100), type: 'warning' }
      ];

      const extraCardsHtml = extraCards.map(card =>
        `<div class="cat-card info-card ${card.type}">
          <h4>${card.title}</h4>
          <div class="cat-metric">${card.value}</div>
          <div class="cat-bar"><span style="width:${card.percent}%"></span></div>
          <div class="cat-pct">${card.percent}%</div>
        </div>`
      ).join('');

      const categoryCardsHtml = entries.map(([cat,data])=>{
        const pct = data.total? Math.round(data.done/data.total*100):0;
        return `<div class="cat-card${pct===100?' highlight':''}"><h4>${cat}</h4><div class="cat-metric">${data.done}/${data.total}</div><div class="cat-bar"><span style="width:${pct}%"></span></div><div class="cat-pct">${pct}%</div></div>`;
      }).join('');

      const finalHtml = extraCardsHtml + categoryCardsHtml;
      console.log('Final HTML length:', finalHtml.length);
      console.log('Final HTML preview:', finalHtml.substring(0, 200));
      holder.innerHTML = finalHtml;
      console.log('Categories rendered, holder children count:', holder.children.length);
    }

    // --- Weekly progress bars ---
    function injectWeekProgress(){
      document.querySelectorAll('.week').forEach(weekEl => {
        const header = weekEl.querySelector('.week-header');
        if(!header) return;
        const daysBlock = weekEl.querySelector('.days');
        const spans = header.querySelectorAll('span');
        const progressText = spans[spans.length-1]?.textContent||''; // x/y
        const match = progressText.match(/(\d+)\/(\d+)/);
        if(!match) return;
        const done = +match[1]; const total = +match[2];
        const pct = total? Math.round(done/total*100):0;
        let bar = weekEl.querySelector('.week-progress');
        if(!bar){
          bar = document.createElement('div');
          bar.className='week-progress';
          bar.dataset.label = pct + '%';
          const fill = document.createElement('span');
          bar.appendChild(fill);
          daysBlock.parentNode.insertBefore(bar, daysBlock);
          requestAnimationFrame(()=>{ fill.style.width = pct+'%'; });
        } else {
          bar.dataset.label = pct + '%';
          const fill = bar.querySelector('span');
          fill.style.width = pct+'%';
        }
      });
    }

    // --- Экспорт / импорт ---
    function estimateStorageUsage(){
      let total = 0; for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); const v = localStorage.getItem(k); total += (k.length + v.length); }
      // localStorage обычно ~5MB per origin. Возьмём 5*1024*1024 ≈ 5242880 bytes.
      const limit = 5 * 1024 * 1024;
      const pct = Math.min(100, Math.round(total / limit * 100));
      const bar = document.getElementById('storageUsageBar'); const pctEl = document.getElementById('storageUsagePct');
      if(bar){ bar.style.width = pct + '%'; }
      if(pctEl){ pctEl.textContent = pct + '%'; pctEl.style.color = pct>80? '#f87171' : pct>60? '#fbbf24' : 'var(--text-secondary)'; }
    }

    // Детализированный разбор использования localStorage
    function debugStorageBreakdown(){
      const rows = [];
      let total = 0;
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        const v = localStorage.getItem(k) || '';
        const size = (k.length + v.length);
        total += size;
        rows.push({ key:k, bytes:size });
      }
      rows.sort((a,b)=>b.bytes-a.bytes);
      return { totalBytes: total, approxKb: (total/1024).toFixed(2), entries: rows };
    }

    // Tooltip для индикатора хранилища
    (function initStorageTooltip(){
      const usage = document.getElementById('storageUsage');
      if(!usage) return;
      let tip;
      usage.addEventListener('mouseenter', ()=>{
        const data = debugStorageBreakdown();
        const biggest = data.entries.slice(0,5).map(r=>`${r.key}: ${(r.bytes/1024).toFixed(2)}KB`).join('\n');
        const txt = `Всего ~${data.approxKb}KB\nТоп ключей:\n${biggest || 'нет'}\nБраузер лимит ~5120KB`;
        tip = document.createElement('div');
        tip.className = 'storage-tooltip';
        tip.textContent = txt;
        document.body.appendChild(tip);
        const rect = usage.getBoundingClientRect();
        tip.style.left = (rect.left + window.scrollX) + 'px';
        tip.style.top = (rect.bottom + 6 + window.scrollY) + 'px';
      });
      usage.addEventListener('mouseleave', ()=>{ if(tip){ tip.remove(); tip=null; } });
    })();

    function render() {
      const html = plan.map(month => {
        const monthProgress = `${month.weeks.reduce((s, w) => s + w.days.filter(d => state[d.day]).length, 0)}/${month.weeks.reduce((s, w) => s + w.days.length, 0)}`;
        const monthTasks = buildMonthTasks(month);
        return `
  <div class="month anim-scale-in">
          <div class="month-header" onclick="toggleMonth(${month.month})">
            <span class="month-title">${month.title}</span>
            <span>${monthProgress}</span>
          </div>
          <div id="month${month.month}" class="${openState.months.includes(month.month) ? '' : 'collapsed'}">
            <div class="month-objectives">
              <div class="mo-goal"><strong>Цель месяца:</strong> ${monthMeta[month.month]?.goal||''}</div>
              <ul class="mo-tasks">${monthTasks.map(t=>`<li>${t}</li>`).join('')}</ul>
            </div>
            ${month.weeks.map(week => {
              const weekDoneCount = week.days.filter(d => state[d.day]).length;
              const weekProgress = `${weekDoneCount}/${week.days.length}`;
              const weekAllDone = weekDoneCount === week.days.length;
              const weekTasks = buildWeekTasks(week);
          return `
              <div class="week anim-slide-down">
                    <div class="week-header ${weekAllDone? 'week-done':''}" onclick="toggleWeek(${week.week})" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){toggleWeek(${week.week});}">
                      <div style="display:flex; align-items:center; gap:4px; flex:1;">
                        <input type="checkbox" class="week-cb" ${weekAllDone? 'checked':''} aria-label="Отметить всю неделю" onclick="event.stopPropagation();" onchange="toggleWeekCheckbox(event, ${week.week})">
                        <span class="week-title-text">${week.title}</span>
                      </div>
                      <span>${weekProgress}</span>
                    </div>
                    <div id="week${week.week}" class="days ${openState.weeks.includes(week.week) ? '' : 'collapsed'}">
                      <div class="week-objectives" style="margin:0 24px 18px 24px; border-radius:14px;">
                        <div class="wg-goal"><strong>Цель недели:</strong> ${weekDescriptions[week.week]||''}</div>
                        <ul class="wg-tasks">${weekTasks.map(t=>`<li>${t}</li>`).join('')}</ul>
                      </div>
                  ${week.days.map(day => {
            const effectiveLinks = buildExtraLinks(day);
            const dayGoal = buildDayGoal(day);
            const dayTasks = buildDayTasks(day);
            return `
                    <div class="day ${state[day.day] ? 'done' : ''}" data-day="${day.day}">
                      <div class="day-header ${dayOpen[day.day] ? 'open':''}" id="dayHeader${day.day}" onclick="toggleDay(${day.day})" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); toggleDay(${day.day});}">
                        <input type="checkbox" ${state[day.day] ? 'checked' : ''} onchange="event.stopPropagation(); toggle(${day.day})" onclick="event.stopPropagation();">
                        <div class="day-title">День ${day.day}: ${day.title}</div>
                        <span class="day-time" style="margin-left:auto;">${day.time}</span>
                      </div>
                      <div class="day-body ${dayOpen[day.day] ? '' : 'collapsed'}" id="dayBody${day.day}">
                        <div class="day-info">
                          <div class="day-goal-line"><strong>Цель:</strong> ${dayGoal}</div>
                          ${dayTasks.length ? `<ul class="day-tasks-list">${dayTasks.map(t=>`<li>${t}</li>`).join('')}</ul>`:''}
                          <div class="day-task">${day.task}</div>
                          ${effectiveLinks.length ? `
                            <div class="day-resources">
                              ${effectiveLinks.map(l => {
              const [title, url] = l.split('||');
              return `<a href=\"${url}\" target=\"_blank\">📚 ${title}</a>`;
            }).join('')}
                            </div>
                          ` : ''}
                          <div class="day-extra" id="extra${day.day}">
                            <div class="day-subtasks" id="subtasks${day.day}">
                              <button type="button" id="subtasksToggle${day.day}" class="section-toggle" onclick="toggleSection(${day.day},'subtasks')">Подзадачи <span class="st-progress" id="subtasksProg${day.day}"></span></button>
                              <div class="section-body" id="subtasksBody${day.day}">
                                <ul class="subtask-list"></ul>
                                <div class="add-subtask">
                                  <input id="newSubtask${day.day}" placeholder="Новая подзадача...">
                                  <button type="button" onclick="addSubtask(${day.day})">Добавить</button>
                                </div>
                              </div>
                            </div>
                            <div class="note-block" id="note${day.day}">
                              <button type="button" id="notesToggle${day.day}" class="section-toggle" onclick="toggleSection(${day.day},'notes')">Заметки</button>
                              <div class="section-body" id="notesBody${day.day}">
                                <input type="text" id="noteInput${day.day}" placeholder="Добавить заметку и Enter" style="width:100%;padding:8px 10px;border:1px solid var(--border-color);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);font-size:12px;" onkeydown="if(event.key==='Enter'){addNote(${day.day}, this.value); this.value=''; event.preventDefault();}">
                                <ul id="notesList${day.day}" style="list-style:none;margin:8px 0 0;padding:0;display:flex;flex-direction:column;gap:6px;"></ul>
                              </div>
                            </div>
                            <div class="attachments-block" id="attachments${day.day}">
                              <button type="button" id="attachmentsToggle${day.day}" class="section-toggle" onclick="toggleSection(${day.day},'attachments')">Файлы и ссылки</button>
                              <div class="section-body" id="attachmentsBody${day.day}">
                                <div class="attach-links">
                                  <input type="text" id="linkTitle${day.day}" placeholder="Название">
                                  <input type="url" id="linkUrl${day.day}" placeholder="https://ссылка...">
                                  <button type="button" onclick="addLink(${day.day})">+</button>
                                </div>
                                <ul class="user-links" id="userLinks${day.day}"></ul>
                                <div class="attach-files file-wrapper">
                                  <span class="attach-hint">Файловые загрузки отключены (экономия памяти). Используй ссылки.</span>
                                </div>
                                <ul class="user-files" id="userFiles${day.day}" style="display:none"></ul>
                              </div>
                            </div>
                          </div>
                          <div id="materialsToggle${day.day}" style="margin-top:10px;">
                            <button id="mtgl${day.day}" class="materials-toggle ${extraOpen[day.day] ? 'open':''}" type="button" onclick="toggleExtra(${day.day})"><span class="arrow">▶</span>${extraOpen[day.day] ? ' Скрыть материалы' : ' Материалы'}<span class="mat-badges"></span></button>
                          </div>
                        </div>
                      </div>
                    </div>`;
          }).join('')}
                </div>
              </div>`;
        }).join('')}
          </div>
        </div>`;
      }).join('');

      document.getElementById('content').innerHTML = html;
      applyFilter();
      // После рендера восстановим пользовательские ссылки/файлы и состояния материалов
  Object.keys(attachmentsState).forEach(day => { renderUserLinks(day); });
  // Инициализация и рендер подзадач (генерируются один раз)
  plan.forEach(m => m.weeks.forEach(w => w.days.forEach(d => { ensureSubtasks(d); renderSubtasks(d.day); })));
  // Обновим бейджи материалов после восстановления списков
  plan.forEach(m => m.weeks.forEach(w => w.days.forEach(d => updateMaterialBadge(d.day))));
      // Скрываем/показываем материалы по сохранённому состоянию
      plan.forEach(m => m.weeks.forEach(w => w.days.forEach(d => {
        const container = document.getElementById('extra'+d.day);
        if(container){ if(!extraOpen[d.day]) container.classList.add('collapsed'); }
        // Применим состояние внутренних секций
        ensureSectionDefaults(d.day);
        ['subtasks','notes','attachments'].forEach(sec => applySectionState(d.day, sec));
        renderNotes(d.day);
      })));
      // Кольца прогресса месяцев (встраиваем после генерации DOM)
      document.querySelectorAll('.month').forEach(monthEl => {
        const header = monthEl.querySelector('.month-header');
        if(!header) return;
        const textSpan = header.querySelector('span:last-child');
        if(!textSpan) return;
        const match = textSpan.textContent.match(/(\d+)\/(\d+)/);
        if(!match) return;
        const done = +match[1]; const total = +match[2];
        const pct = total ? Math.round(done/total*100) : 0;
        if(!header.querySelector('.month-ring')){
          const ring = document.createElement('div');
          ring.className='month-ring';
          ring.style.setProperty('--p', pct);
          ring.innerHTML = '<span>'+pct+'%</span>';
          header.insertBefore(ring, header.firstChild);
        } else {
          const ring = header.querySelector('.month-ring');
          ring.style.setProperty('--p', pct);
          ring.innerHTML = '<span>'+pct+'%</span>';
        }
      });
      injectWeekProgress();
      renderCategorySummary();
      estimateStorageUsage();
    }

    function toggleMonth(m) {
      const idx = openState.months.indexOf(m);
      if (idx === -1) {
        openState.months.push(m);
      } else {
        openState.months.splice(idx, 1);
      }
      // При закрытии месяца закрываем все его недели
      if (openState.months.indexOf(m) === -1) {
        const monthObj = plan.find(mon => mon.month === m);
        if (monthObj) {
          monthObj.weeks.forEach(w => {
            const wIdx = openState.weeks.indexOf(w.week);
            if (wIdx !== -1) openState.weeks.splice(wIdx, 1);
          });
        }
      }
      saveOpenState();
      render();
    }

    function toggleWeek(w) {
      const idx = openState.weeks.indexOf(w);
      if (idx === -1) {
        openState.weeks.push(w);
      } else {
        openState.weeks.splice(idx, 1);
      }
      saveOpenState();
      render();
    }

    function toggleWeekCheckbox(ev, weekNum){
      const weekObj = plan.flatMap(m=>m.weeks).find(w=>w.week===weekNum);
      if(!weekObj) return;
      const shouldCheck = ev.target.checked; // если включили — отмечаем все дни; если сняли — снимаем
      weekObj.days.forEach(d => { state[d.day] = !!shouldCheck; });
      // Сохраним раскрытость недели до рендера, чтобы прогресс-бар сразу пересчитал позицию
      if(!openState.weeks.includes(weekNum)) { openState.weeks.push(weekNum); saveOpenState(); }
      save(); // save() сам вызовет scheduleCloudUpload
      updateStats();
      render();
    }

    function filter(type) {
      currentFilter = type;
      document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      applyFilter();
    }

    function resetFilter(){ currentFilter='all'; document.querySelectorAll('.btn-filter').forEach(b=>b.classList.remove('active')); document.querySelector('.btn-filter[onclick="filter('+'\'all\''+')"]')?.classList.add('active'); applyFilter(); }

    function scrollToNextIncomplete(){
      const visibleDays = Array.from(document.querySelectorAll('.day')).filter(d=>d.style.display !== 'none');
      const next = visibleDays.find(d => !state[d.dataset.day]);
      if(next){ next.scrollIntoView({behavior:'smooth', block:'center'}); next.classList.add('highlight-temp'); setTimeout(()=>next.classList.remove('highlight-temp'),1500); }
      else { alert('Все видимые дни завершены 🎉'); }
    }
    function expandAll(){ openState.months = plan.map(m=>m.month); openState.weeks = plan.flatMap(m=>m.weeks.map(w=>w.week)); saveOpenState(); render(); }
    function collapseAll(){ openState.months = []; openState.weeks = []; saveOpenState(); render(); }

    function applyFilter() {
      document.querySelectorAll('.day').forEach(day => {
        const dayNum = day.dataset.day;
        const done = state[dayNum];
        let show = currentFilter === 'all' ||
          (currentFilter === 'done' && done) ||
          (currentFilter === 'todo' && !done);
        day.style.display = show ? 'block' : 'none';
      });
    }

    function reset() {
      if (!confirm('Сбросить весь прогресс (отметки дней)?')) return;
      state = {};
      try { localStorage.removeItem('frontendPlan'); } catch(_){ }
      // Сбрасываем локальный хэш, чтобы облако приняло новый пустой снапшот
      lastUploadedHash = null;
      maybeStoreHistory(true);
      save(); // сохранит пустое состояние и поставит sync
      updateStats();
      render();
      flashIndicator();
    }

    const searchEl = document.getElementById('search');
    if(searchEl){
      searchEl.oninput = (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.day').forEach(day => {
          const match = day.textContent.toLowerCase().includes(term);
          day.style.display = match ? 'block' : 'none';
        });
      };
    }

    // Автозагрузка Firebase, если ранее был вход
    if(localStorage.getItem('cloudWasSignedIn')){
      // loadFirebaseCompat уже установит onAuthStateChanged и восстановит пользователя из persistence
      if(typeof loadFirebaseCompat === 'function') loadFirebaseCompat();
    }
    // Периодическое сохранение в локальную историю (каждые 10 минут)
    setInterval(()=>{ try { maybeStoreHistory(); } catch(_){ } }, 10*60*1000);
    // Перед закрытием вкладки — тоже сохраняем последнюю версию
    window.addEventListener('beforeunload', ()=>{ try { maybeStoreHistory(); } catch(_){ } });
    updateStats();
    render();
    if(typeof updateCloudUI === 'function') updateCloudUI();

    // === Появление панели быстрых действий после прокрутки ===
    (function initQuickPanelAppear(){
      const qp = document.querySelector('.quick-panel');
      if(!qp) return;
      let shown = false;
      const threshold = 320; // px
      function onScroll(){
        if(window.scrollY > threshold){
          if(!shown){ qp.classList.add('visible'); shown=true; }
        } else {
          if(shown){ qp.classList.remove('visible'); shown=false; }
        }
      }
      window.addEventListener('scroll', onScroll, { passive:true });
      // если страница уже ниже порога при загрузке
      requestAnimationFrame(onScroll);
    })();
  </script>
</body>

</html>
